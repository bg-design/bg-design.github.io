<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wombat Quest - Step 8: World Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #f0f0f0;
        }

        /* Menu Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .menu-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .menu-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .menu-header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-header .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .menu-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #007bff;
        }

        .menu-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-section p {
            margin: 8px 0;
            color: #6c757d;
            line-height: 1.5;
        }

        .menu-section strong {
            color: #495057;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .control-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .control-item strong {
            color: #007bff;
            display: block;
            margin-bottom: 5px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .volume-slider {
            flex: 1;
            max-width: 200px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }

        .seed-display {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: bold;
            color: #007bff;
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            border: 2px solid #dee2e6;
            display: inline-block;
            margin: 5px;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .close-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-menu:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Menu toggle hint */
        .menu-hint {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        /* Top Info Panel */
        .top-info-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #ff6b35;
            z-index: 100;
            text-align: center;
        }

        .time-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .time-display {
            color: #ffd23f;
            font-size: 1.1em;
            font-weight: bold;
            margin: 0;
        }

        .version-display {
            position: fixed;
            bottom: 5px;
            right: 5px;
            color: #888;
            font-size: 0.7em;
            font-weight: normal;
            opacity: 0.7;
            z-index: 1000;
        }

        .pause-btn {
            background: rgba(255, 107, 53, 0.8);
            border: 2px solid #ff6b35;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .pause-icon {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }

        .pause-bar {
            width: 3px;
            height: 12px;
            background: white;
            border-radius: 1px;
        }

        .pause-btn:hover {
            background: #ff6b35;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.6);
        }

        .pause-btn.paused {
            background: rgba(255, 0, 0, 0.8);
            border-color: #ff0000;
        }

        .pause-btn.paused:hover {
            background: #ff0000;
        }

        .light-toggle-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #ffd23f;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .light-toggle-btn:hover {
            background: #ffd23f;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 210, 63, 0.6);
        }

        .light-toggle-btn.lights-off {
            background: rgba(100, 100, 100, 0.8);
            border-color: #666;
            opacity: 0.6;
        }

        .light-toggle-btn.lights-off:hover {
            background: #666;
        }

        .light-icon {
            transition: all 0.3s ease;
        }

        .light-toggle-btn.lights-off .light-icon {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .light-toggle-btn.disabled {
            background: rgba(60, 60, 60, 0.5);
            border-color: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .light-toggle-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .activities-display {
            color: #ffd23f;
            font-size: 0.9em;
            line-height: 1.3;
        }

        .activities-display p {
            margin: 2px 0;
            font-size: 0.85em;
        }

        /* Inventory Panel */
        .inventory-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #8b5cf6;
            min-width: 150px;
            z-index: 100;
        }

        .inventory-title {
            color: #8b5cf6;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .inventory-item {
            background: rgba(139, 92, 246, 0.2);
            padding: 6px 10px;
            margin: 3px 0;
            border-radius: 12px;
            font-size: 0.9em;
            border: 1px solid #8b5cf6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .inventory-item:hover {
            background: rgba(139, 92, 246, 0.4);
            border-color: #a855f7;
            transform: scale(1.05);
        }

        .inventory-item .quantity {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            color: #ffd23f;
        }

        .menu-hint-inventory {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(139, 92, 246, 0.3);
            color: #ffd23f;
            font-size: 0.8em;
            text-align: center;
        }

        /* Stats Panel */
        .stats-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffd23f;
            min-width: 200px;
            z-index: 100;
        }

        .stat-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .stat-label {
            width: 60px;
            color: #ffd23f;
            font-weight: bold;
        }

        .coin-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #ffd23f;
            font-weight: bold;
        }

        .stat-progress {
            flex: 1;
            height: 4px;
            background: #333;
            border: 1px solid #555;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 0 0 10px;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .stat-value {
            display: none;
        }

        .thirst-fill { background: linear-gradient(90deg, #00bfff, #0080ff); }
        .hunger-fill { background: linear-gradient(90deg, #ff6b35, #ff4500); }
        .energy-fill { background: linear-gradient(90deg, #ffd23f, #ffed4e); }
        .mood-fill { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
        .light-fill { background: linear-gradient(90deg, #ffffff, #f0f0f0); }
        .karma-fill { background: linear-gradient(90deg, #06ffa5, #00ff88); }

        /* Battery Meter Styles */
        .battery-meter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            padding: 4px 0;
        }

        .battery-label {
            color: #ffd23f;
            font-size: 0.9em;
            font-weight: bold;
            width: 60px;
        }

        .battery-segments {
            display: flex;
            gap: 2px;
            flex: 1;
        }

        .battery-segment {
            height: 12px;
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .battery-segment.active {
            background: linear-gradient(90deg, #ffffff, #f0f0f0);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.4);
        }

        .battery-segment.low {
            background: linear-gradient(90deg, #ff6b35, #ff4500);
            border-color: rgba(255, 107, 53, 0.6);
            box-shadow: 0 0 4px rgba(255, 107, 53, 0.4);
        }

        .coin-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .karma-display {
            margin-top: 8px;
        }

        .karma-display .coin-amount {
            color: #06ffa5;
        }

        /* Action Panel */
        .actions-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ff6b35;
            max-width: 300px;
            z-index: 100;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .action-btn {
            background: #1c1c28;
            color: #eae9ff;
            border: 1px solid #2a2a3d;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            min-height: 44px;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #232334;
            border-color: #ff6b35;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Drug Effects Panel */
        .drug-effects-panel {
            position: fixed;
            top: 280px;
            right: 20px;
            background: rgba(139, 92, 246, 0.9);
            border: 2px solid #a855f7;
            border-radius: 12px;
            padding: 12px;
            color: #fff;
            font-size: 0.9em;
            min-width: 200px;
            display: none;
        }

        .drug-effect-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .drug-effect-item:last-child {
            margin-bottom: 0;
        }

        .drug-effect-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .drug-effect-text {
            flex-grow: 1;
        }

        .drug-effect-duration {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Top Info Panel -->
    <div class="top-info-panel">
        <div class="time-controls">
            <div class="time-display" id="time-display">Day 1 ‚Ä¢ 08:00</div>
            <button class="light-toggle-btn" id="light-toggle-btn" title="Toggle Lights On/Off">
                <div class="light-icon" id="light-icon">üí°</div>
            </button>
            <button class="pause-btn" id="pause-btn">
                <div class="pause-icon">
                    <div class="pause-bar"></div>
                    <div class="pause-bar"></div>
                </div>
            </button>
        </div>
        <div class="activities-display" id="activities-display">
            <p>Welcome to Burning Man! The playa is starting to fill up...</p>
        </div>
    </div>
    
    <!-- Inventory Panel -->
    <div class="inventory-panel">
        <div class="inventory-title">üéí Inventory</div>
        <div id="inventory-list">
            <!-- Inventory will be populated here -->
        </div>
        <div class="menu-hint-inventory">
            Press <strong>ESC</strong> to open menu
        </div>
    </div>
    
    <!-- Stats Panel -->
    <div class="stats-panel">
        <div class="stat-bar">
            <div class="stat-label">Thirst</div>
            <div class="stat-progress">
                <div class="stat-fill thirst-fill" id="thirst-bar"></div>
            </div>
            <div class="stat-value" id="thirst-value">100</div>
        </div>
        <div class="stat-bar">
            <div class="stat-label">Hunger</div>
            <div class="stat-progress">
                <div class="stat-fill hunger-fill" id="hunger-bar"></div>
            </div>
            <div class="stat-value" id="hunger-value">100</div>
        </div>
        <div class="stat-bar">
            <div class="stat-label">Energy</div>
            <div class="stat-progress">
                <div class="stat-fill energy-fill" id="energy-bar"></div>
            </div>
            <div class="stat-value" id="energy-value">100</div>
        </div>
        <div class="stat-bar">
            <div class="stat-label">Mood</div>
            <div class="stat-progress">
                <div class="stat-fill mood-fill" id="mood-bar"></div>
            </div>
            <div class="stat-value" id="mood-value">100</div>
        </div>
        <div class="coin-display">
            <div class="coin-label">Coins</div>
            <div class="coin-amount" id="coin-amount">0</div>
        </div>
        <div class="coin-display karma-display">
            <div class="coin-label">Karma</div>
            <div class="coin-amount" id="karma-amount">0</div>
        </div>
        <div class="coin-display">
            <div class="coin-label">Speed</div>
            <div class="coin-amount" id="speed-display">1.0x</div>
        </div>
        <div class="coin-display">
            <div class="coin-label">Time</div>
            <div class="coin-amount" id="time-perception-display">1.0x</div>
        </div>
        
        <!-- Battery Meter -->
        <div class="battery-meter">
            <div class="battery-label">Battery</div>
            <div class="battery-segments" id="battery-segments">
                <div class="battery-segment" data-segment="0"></div>
                <div class="battery-segment" data-segment="1"></div>
                <div class="battery-segment" data-segment="2"></div>
                <div class="battery-segment" data-segment="3"></div>
                <div class="battery-segment" data-segment="4"></div>
                <div class="battery-segment" data-segment="5"></div>
                <div class="battery-segment" data-segment="6"></div>
                <div class="battery-segment" data-segment="7"></div>
                <div class="battery-segment" data-segment="8"></div>
                <div class="battery-segment" data-segment="9"></div>
            </div>
        </div>
    </div>
    
    <!-- Action Panel -->
    <div class="actions-panel">
        <div class="action-grid">
            <button class="action-btn" data-action="explore">Explore</button>
            <button class="action-btn" data-action="gift">Give Gift [G]</button>
            <button class="action-btn" data-action="rest">Rest (nap) [R]</button>
            <button class="action-btn" data-action="help">Help Stranger</button>
            <button class="action-btn" data-action="battle">Silly Battle</button>
            <button class="action-btn" data-action="meditate">Meditate</button>
        </div>
    </div>
    
    <!-- Drug Effects Panel -->
    <div class="drug-effects-panel" id="drug-effects-panel">
        <div style="font-weight: bold; margin-bottom: 8px; color: #ffd700;">Active Effects</div>
        <div id="drug-effects-list">
            <!-- Drug effects will be populated here -->
        </div>
    </div>
    
    <!-- Version Display -->
    <div class="version-display">v1</div>

    <div class="menu-overlay" id="menuOverlay">
        <div class="menu-container">
            <button class="close-menu" id="closeMenu">&times;</button>
            
            <div class="menu-header">
                <h1>üéÆ Wombat Quest</h1>
                <p class="subtitle">Step 8: World Management System</p>
            </div>

            <!-- Tabs header -->
            <div class="menu-tabs">
                <button class="menu-tab active" data-tab="session">Session</button>
                <button class="menu-tab" data-tab="settings">Settings</button>
            </div>

            <!-- Tab: Session -->
            <div class="menu-tab-panel" id="tab-session" style="display:block;">
                <div class="menu-section">
                    <h3>üéÆ Game Controls</h3>
                    <div class="controls-grid">
                        <div class="control-item">
                            <strong>WASD / Arrow Keys</strong>
                            Move the player
                        </div>
                        <div class="control-item">
                            <strong>E</strong>
                            Rest (restore energy & mood)
                        </div>
                        <div class="control-item">
                            <strong>L</strong>
                            Toggle lights on/off
                        </div>
                        <div class="control-item">
                            <strong>ESC</strong>
                            Open/close this menu
                        </div>
                        <div class="control-item">
                            <strong>Walk to edges</strong>
                            Transition between worlds
                        </div>
                    </div>
                </div>

                <div class="menu-section">
                    <h3>üåç World Navigation</h3>
                    <p><strong>Camp</strong> - Your home base (1 sec = 1 min)</p>
                    <p><strong>The Playa</strong> - Vast desert with landmarks (1 sec = 1 hour)</p>
                    <p><strong>Dance Stage</strong> - Main stage with lights (1 sec = 30 sec)</p>
                    <p>Walk to world edges or enter the green camp area on the Playa to transition!</p>
                </div>

                <div class="menu-section">
                    <h3>üîä Audio Controls</h3>
                    <p><strong>M</strong> - Toggle mute/unmute (in-game)</p>
                    <div class="audio-controls">
                        <span>Volume:</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="70">
                        <span id="volumeDisplay">70%</span>
                    </div>
                </div>

                <div class="menu-section">
                    <h3>üìä Game Mechanics</h3>
                    <p><strong>Energy</strong> - Decreases as you move around</p>
                    <p><strong>Mood</strong> - Decreases over time, faster when energy is low</p>
                    <p><strong>Coins</strong> - Collect to increase your coin count</p>
                    <p>Watch the stat bars in the top-left corner of the game!</p>
                </div>

                <div class="menu-section">
                    <h3>üé≤ Game Seed</h3>
                    <p>Current seed: <span class="seed-display" id="seedDisplay">Loading...</span></p>
                    <div class="button-group">
                        <button id="resetSeed">Reset Game (seed=<span id="resetSeedDisplay">Loading...</span>)</button>
                    </div>
                </div>

                <div class="menu-section">
                    <h3>‚è∏Ô∏è Session</h3>
                    <div class="button-group">
                        <button id="resumeGame">Resume</button>
                    </div>
                </div>

                <div class="menu-section">
                    <h3>üíæ Save & Load</h3>
                    <div class="button-group">
                        <button id="saveGame">Save Game</button>
                        <button id="loadGame">Load Game</button>
                    </div>
                    <div id="statusMessage" class="status-message" style="display: none;"></div>
                </div>
            </div>

            <!-- Tab: Settings -->
            <div class="menu-tab-panel" id="tab-settings" style="display:none;">
                <div class="menu-section">
                    <h3>üîä Audio Controls</h3>
                    <p><strong>M</strong> - Toggle mute/unmute (in-game)</p>
                    <div class="audio-controls">
                        <span>Volume:</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="70">
                        <span id="volumeDisplay">70%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { App } from './app/index';

        // Initialize the app
        const app = new App({
            canvasWidth: window.innerWidth,
            canvasHeight: window.innerHeight,
            playerSize: 32,
            seed: Math.floor(Math.random() * 1000000),
            coinCount: 30 // 30% of current 100 coins
        });

        // Menu functionality
        const menuOverlay = document.getElementById('menuOverlay');
        const menuContent = document.querySelector('.menu-container');
        const closeMenu = document.getElementById('closeMenu');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const audio = app.getAudio();

        // Set initial volume
        audio.setMasterVolume(volumeSlider.value / 100);
        volumeDisplay.textContent = volumeSlider.value + '%';

        // Handle volume changes
        volumeSlider.addEventListener('input', () => {
            const volume = volumeSlider.value / 100;
            audio.setMasterVolume(volume);
            volumeDisplay.textContent = volumeSlider.value + '%';
        });

        // Make overlay/content translucent and offset content from top bar
        if (menuOverlay) {
            menuOverlay.style.background = 'rgba(0,0,0,0.35)';
        }
        if (menuContent) {
            menuContent.style.background = 'rgba(17,24,39,0.85)';
            menuContent.style.backdropFilter = 'blur(2px)';
            menuContent.style.marginTop = '80px';
        }

        // Menu toggle functionality
        function toggleMenu() {
            const isOpen = !menuOverlay.classList.contains('show');
            if (isOpen) {
                menuOverlay.classList.add('show');
                window.dispatchEvent(new CustomEvent('openMenu'));
                // Default to Session tab on open
                switchTab('session');
            } else {
                menuOverlay.classList.remove('show');
                window.dispatchEvent(new CustomEvent('closeMenu'));
            }
        }

        function closeMenuHandler() {
            if (menuOverlay.classList.contains('show')) {
                menuOverlay.classList.remove('show');
                window.dispatchEvent(new CustomEvent('closeMenu'));
            }
        }

        // Event listeners for menu
        closeMenu.addEventListener('click', closeMenuHandler);
        menuOverlay.addEventListener('click', (e) => {
            if (e.target === menuOverlay) {
                closeMenuHandler();
            }
        });

        // Listen for custom menu toggle event from game loop
        window.addEventListener('toggleMenu', toggleMenu);

        // Update seed display
        const seedDisplay = document.getElementById('seedDisplay');
        const resetSeedDisplay = document.getElementById('resetSeedDisplay');
        const rng = app.getRng();
        const currentSeed = rng.getSeed();
        seedDisplay.textContent = currentSeed.toString();
        resetSeedDisplay.textContent = currentSeed.toString();

        // Reset button handler
        const resetBtn = document.getElementById('resetSeed');
        resetBtn.addEventListener('click', () => {
            app.reset();
            closeMenuHandler();
        });

        // Resume button handler
        const resumeBtn = document.getElementById('resumeGame');
        resumeBtn.addEventListener('click', () => {
            closeMenuHandler();
        });

        // Save/Load button handlers
        const saveBtn = document.getElementById('saveGame');
        const loadBtn = document.getElementById('loadGame');
        const statusMessage = document.getElementById('statusMessage');

        function showStatus(message, isSuccess = true) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${isSuccess ? 'status-success' : 'status-error'}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        saveBtn.addEventListener('click', async () => {
            try {
                await app.saveGame();
                showStatus('Game saved successfully!', true);
            } catch (error) {
                showStatus('Failed to save game', false);
                console.error('Save error:', error);
            }
        });

        loadBtn.addEventListener('click', async () => {
            try {
                const success = await app.loadGame();
                if (success) {
                    showStatus('Game loaded successfully!', true);
                } else {
                    showStatus('No save data found', false);
                }
            } catch (error) {
                showStatus('Failed to load game', false);
                console.error('Load error:', error);
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('gameCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // UI Update Functions
        function updateStatsDisplay(gameState) {
            const stats = gameState.player.stats;
            console.log('updateStatsDisplay called, lightBattery:', stats.lightBattery);
            
            // Check if player has any light bulbs and update light toggle button
            const hasLights = hasAnyLightBulbs(gameState.player.inventory);
            updateLightToggleButton(gameState.player.lightsOn, hasLights);
            
            // Update stat bars
            document.getElementById('thirst-bar').style.width = `${Math.max(0, Math.min(100, stats.thirst))}%`;
            document.getElementById('hunger-bar').style.width = `${Math.max(0, Math.min(100, stats.hunger))}%`;
            document.getElementById('energy-bar').style.width = `${Math.max(0, Math.min(100, stats.energy))}%`;
            document.getElementById('mood-bar').style.width = `${Math.max(0, Math.min(100, stats.mood))}%`;
            
            // Update stat values
            document.getElementById('thirst-value').textContent = Math.round(stats.thirst);
            document.getElementById('hunger-value').textContent = Math.round(stats.hunger);
            document.getElementById('energy-value').textContent = Math.round(stats.energy);
            document.getElementById('mood-value').textContent = Math.round(stats.mood);
            
            // Update battery display
            updateBatteryDisplay(stats.lightBattery);
            
            // Update coins and karma
            document.getElementById('coin-amount').textContent = stats.coins;
            document.getElementById('karma-amount').textContent = Math.round(stats.karma);
        }

        // Function to get hotkey for an item
        function getItemHotkey(itemType) {
            const hotkeys = {
                'Water': 'W',
                'Grilled Cheese': 'J',
                'Energy Bar': 'E',
                'Trinket': 'T',
                'Clothing': 'C',
                'Veggie Burger': 'V',
                'Fruit Salad': 'F',
                'Pizza Slice': 'P',
                'Smoothie': 'S',
                'Popsicle': 'O',
                'Burrito': 'B',
                'Taco': 'A',
                'Ice Cream': 'I',
                'Corn Dog': 'D',
                'Funnel Cake': 'U',
                'Nachos': 'N',
                'Cotton Candy': 'Y',
                'Gas Can': 'G'
            };
            return hotkeys[itemType] || null;
        }

        // Store item elements to avoid recreating them
        const inventoryItemElements = new Map();
        
        function updateInventoryDisplay(gameState) {
            const inventoryList = document.getElementById('inventory-list');
            const inventory = gameState.player.inventory;
            
            if (!inventory || !inventory.items) return;
            
            // Item emojis mapping
            const itemEmojis = {
                'Water': 'üíß',
                'Grilled Cheese': 'üßÄ',
                'Energy Bar': '‚ö°',
                'Trinket': '‚ú®',
                'Clothing': 'üëï',
                'Veggie Burger': 'üçî',
                'Fruit Salad': 'ü•ó',
                'Pizza Slice': 'üçï',
                'Smoothie': 'ü•§',
                'Popsicle': 'üç≠',
                'Burrito': 'üåØ',
                'Taco': 'üåÆ',
                'Ice Cream': 'üç¶',
                'Corn Dog': 'üå≠',
                'Funnel Cake': 'üßÅ',
                'Nachos': 'üåΩ',
                'Cotton Candy': 'üç¨',
                'Gas Can': '‚õΩ',
                'Light Bulb': 'üí°',
                'Light Bulb White': 'üí°',
                'Light Bulb Red': 'üî¥',
                'Light Bulb Green': 'üü¢',
                'Light Bulb Blue': 'üîµ',
                'Light Bulb Orange': 'üü†',
                'Light Bulb Purple': 'üü£',
                'Light Bulb Rainbow': 'üåà',
                'Battery': 'üîã',
                // Fallback for lowercase versions (in case they exist)
                'Light Bulb green': 'üü¢',
                'Light Bulb red': 'üî¥',
                'Light Bulb blue': 'üîµ',
                'Light Bulb orange': 'üü†',
                'Light Bulb purple': 'üü£',
                'Light Bulb white': 'üí°',
                'Light Bulb rainbow': 'üåà'
            };
            
            // Get current items in inventory
            const currentItems = new Set();
            
            // Update existing items or create new ones
            inventory.items.forEach((quantity, itemType) => {
                currentItems.add(itemType);
                
                if (quantity > 0) {
                    let itemDiv = inventoryItemElements.get(itemType);
                    
                    if (!itemDiv) {
                        // Create new item element
                        itemDiv = document.createElement('div');
                        itemDiv.className = 'inventory-item';
                        itemDiv.style.cursor = 'pointer';
                        
                        const emoji = itemEmojis[itemType] || 'üì¶';
                        const hotkey = getItemHotkey(itemType);
                        const hotkeyText = hotkey ? ` [${hotkey}]` : '';
                        
                        itemDiv.innerHTML = `
                            <span>${emoji} ${itemType}${hotkeyText}</span>
                            <span class="quantity">${quantity}</span>
                        `;
                        
                        // Add click event listener (only once)
                        itemDiv.addEventListener('click', () => {
                            console.log('Inventory item clicked:', itemType);
                            window.dispatchEvent(new CustomEvent('useInventoryItem', { 
                                detail: { itemType: itemType } 
                            }));
                        });
                        
                        inventoryItemElements.set(itemType, itemDiv);
                        inventoryList.appendChild(itemDiv);
                    } else {
                        // Update quantity of existing item
                        const quantitySpan = itemDiv.querySelector('.quantity');
                        if (quantitySpan) {
                            quantitySpan.textContent = quantity;
                        }
                    }
                }
            });
            
            // Remove items that are no longer in inventory
            for (const [itemType, itemDiv] of inventoryItemElements) {
                if (!currentItems.has(itemType)) {
                    itemDiv.remove();
                    inventoryItemElements.delete(itemType);
                }
            }
        }

        function updateTimeDisplay(gameState) {
            const timeDisplay = document.getElementById('time-display');
            const time = gameState.time;
            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][(time.day + 5) % 7];
            const timeStr = `${time.hour.toString().padStart(2, '0')}:${time.minute.toString().padStart(2, '0')}`;
            timeDisplay.textContent = `Day ${time.day} (${dayName}) ‚Ä¢ ${timeStr}`;
        }

        function updateDrugEffectsDisplay(gameState) {
            const drugEffectsPanel = document.getElementById('drug-effects-panel');
            const drugEffectsList = document.getElementById('drug-effects-list');
            const drugs = gameState.player.drugs;
            
            if (!drugs || !drugs.active || drugs.active.length === 0) {
                drugEffectsPanel.style.display = 'none';
                return;
            }
            
            drugEffectsPanel.style.display = 'block';
            drugEffectsList.innerHTML = '';
            
            // Sort drugs by duration (longest first)
            const sortedDrugs = [...drugs.active].sort((a, b) => b.duration - a.duration);
            
            // Drug emoji mapping
            const drugEmojis = {
                'molly': 'üíé', 'shrooms': 'üçÑ', 'acid': 'üß™', 'dmt': 'üí´', 'salvia': 'üåø',
                'whipits': 'üéà', 'energy-drink': 'üçº', 'mystery-pill': '‚ùì', 'mystery-snowball': '‚ùÑÔ∏è',
                'cigarette': 'üö¨', 'joint': 'üö¨', 'vodka': 'ü•É', 'mda': 'üíé', '2c-i': 'üß™',
                'caffeine': '‚òï', 'alcohol': 'üç∫', 'mdma': 'üíé',
                'weed': 'üåø', 'cocaine': '‚ö™', 'ketamine': '‚ö™', 'cannabis': 'üåø'
            };
            
            sortedDrugs.forEach(drug => {
                const drugDiv = document.createElement('div');
                drugDiv.className = 'drug-effect-item';
                
                // Get drug-specific emoji
                const emoji = drugEmojis[drug.type] || '‚ùì';
                
                // Capitalize drug name properly
                const capitalizedName = drug.type.charAt(0).toUpperCase() + drug.type.slice(1).replace('-', ' ');
                
                drugDiv.innerHTML = `
                    <span class="drug-effect-icon">${emoji}</span>
                    <span class="drug-effect-text">${capitalizedName}</span>
                    <span class="drug-effect-duration">${Math.round(drug.duration)}s</span>
                `;
                drugEffectsList.appendChild(drugDiv);
            });
        }

        function updateSpeedDisplay(gameState) {
            const speedDisplay = document.getElementById('speed-display');
            const timeDisplay = document.getElementById('time-perception-display');
            
            if (!gameState || !gameState.player) return;
            
            // Calculate effective speed including drug effects
            const playerStats = gameState.player.stats;
            const baseSpeed = playerStats.speed || 100;
            
            // Calculate speed multiplier from stats (energy, thirst, hunger, mood)
            let speedMultiplier = 1.0;
            if (playerStats.energy < 30) speedMultiplier *= 0.7;
            if (playerStats.thirst < 30) speedMultiplier *= 0.8;
            if (playerStats.hunger < 30) speedMultiplier *= 0.8;
            if (playerStats.mood < 30) speedMultiplier *= 0.9;
            
            // Add drug speed effects
            if (gameState.player.drugs && gameState.player.drugs.active) {
                gameState.player.drugs.active.forEach(drug => {
                    if (drug.effects && drug.effects.speed) {
                        speedMultiplier += (drug.effects.speed * drug.intensity) / 100;
                    }
                });
            }
            
            const effectiveSpeed = Math.max(0.1, speedMultiplier);
            
            // Calculate time scale from drug effects
            let timeScale = 1.0;
            if (gameState.player.drugs && gameState.player.drugs.active) {
                gameState.player.drugs.active.forEach(drug => {
                    if (drug.effects && drug.effects.timeScale) {
                        timeScale *= drug.effects.timeScale;
                    }
                });
            }
            
            speedDisplay.textContent = `${effectiveSpeed.toFixed(1)}x`;
            timeDisplay.textContent = `${timeScale.toFixed(1)}x`;
        }

        function updatePauseButton(isPaused) {
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn) {
                if (isPaused) {
                    pauseBtn.classList.add('paused');
                } else {
                    pauseBtn.classList.remove('paused');
                }
            }
        }

        function hasAnyLightBulbs(inventory) {
            const lightBulbTypes = [
                'Light Bulb', 'Light Bulb White', 'Light Bulb Red', 'Light Bulb Green', 
                'Light Bulb Blue', 'Light Bulb Orange', 'Light Bulb Purple', 'Light Bulb Rainbow'
            ];
            
            for (const bulbType of lightBulbTypes) {
                const count = inventory.items.get(bulbType) || 0;
                if (count > 0) {
                    return true;
                }
            }
            return false;
        }

        function updateLightToggleButton(lightsOn, hasLights = true) {
            const lightToggleBtn = document.getElementById('light-toggle-btn');
            const lightIcon = document.getElementById('light-icon');
            if (lightToggleBtn && lightIcon) {
                // Remove all state classes first
                lightToggleBtn.classList.remove('lights-off', 'disabled');
                
                if (!hasLights) {
                    // No lights available - disable button
                    lightToggleBtn.classList.add('disabled');
                    lightIcon.textContent = 'üí°';
                    lightToggleBtn.disabled = true;
                } else if (lightsOn) {
                    // Lights are on
                    lightIcon.textContent = 'üí°';
                    lightToggleBtn.disabled = false;
                } else {
                    // Lights are off
                    lightToggleBtn.classList.add('lights-off');
                    lightIcon.textContent = 'üî¶';
                    lightToggleBtn.disabled = false;
                }
            }
        }

        function updateBatteryDisplay(batteryLevel) {
            console.log('updateBatteryDisplay called with batteryLevel:', batteryLevel);
            const segments = document.querySelectorAll('.battery-segment');
            console.log('Found battery segments:', segments.length);
            const activeSegments = Math.floor(batteryLevel / 10); // Each segment = 10%
            console.log('Active segments:', activeSegments);
            
            segments.forEach((segment, index) => {
                segment.classList.remove('active', 'low');
                
                if (index < activeSegments) {
                    if (batteryLevel <= 30) {
                        segment.classList.add('low'); // Red when low
                    } else {
                        segment.classList.add('active'); // White when normal
                    }
                }
            });
        }

        // Tabs logic
        function switchTab(tab) {
            document.querySelectorAll('.menu-tab').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
            });
            document.querySelectorAll('.menu-tab-panel').forEach(panel => {
                panel.style.display = panel.id === `tab-${tab}` ? 'block' : 'none';
            });
        }
        document.querySelectorAll('.menu-tab').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
        });

        // Set up periodic UI updates
        function updateUI(gameState) {
            updateStatsDisplay(gameState);
            updateInventoryDisplay(gameState);
            updateTimeDisplay(gameState);
            updateDrugEffectsDisplay(gameState);
            updateSpeedDisplay(gameState);
        }

        // Listen for game state updates
        window.addEventListener('gameStateUpdate', (event) => {
            updateUI(event.detail);
        });

        // Listen for pause state updates
        window.addEventListener('pauseStateUpdate', (event) => {
            updatePauseButton(event.detail.isPaused);
        });

        // Listen for light state updates
        window.addEventListener('lightStateUpdate', (event) => {
            updateLightToggleButton(event.detail.lightsOn);
        });

        // Pause button functionality
        const pauseBtn = document.getElementById('pause-btn');
        if (pauseBtn) {
            pauseBtn.addEventListener('click', () => {
                // Open/close menu (which handles pause/resume)
                toggleMenu();
            });
        }

        // Light toggle button functionality
        const lightToggleBtn = document.getElementById('light-toggle-btn');
        if (lightToggleBtn) {
            lightToggleBtn.addEventListener('click', () => {
                console.log('Light toggle button clicked - disabled:', lightToggleBtn.disabled);
                // Only allow toggling if button is not disabled
                if (!lightToggleBtn.disabled) {
                    console.log('Dispatching toggleLights event');
                    // Dispatch light toggle event to game loop
                    window.dispatchEvent(new CustomEvent('toggleLights'));
                } else {
                    console.log('Light toggle button is disabled - click ignored');
                }
            });
        }

        // Action button functionality
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.getAttribute('data-action');
                if (action) {
                    // Dispatch action event to game loop
                    window.dispatchEvent(new CustomEvent('playerAction', { detail: { action } }));
                }
            });
        });

        // Start the game
        app.start().catch((error) => {
            console.error('Failed to start game:', error);
            document.getElementById('seedDisplay').textContent = 'Error loading game';
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            app.stop();
        });

        // Also close menu with ESC directly
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && menuOverlay.classList.contains('show')) {
                e.preventDefault();
                closeMenuHandler();
            }
        });
    </script>
</body>
</html>