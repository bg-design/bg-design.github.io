var mt=Object.defineProperty;var St=(o,t,e)=>t in o?mt(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var y=(o,t,e)=>St(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const wt=200;function x(o,t){return{x:o,y:t}}function Mt(o,t){return{x:o.x+t.x,y:o.y+t.y}}function vt(o,t){return{x:o.x*t,y:o.y*t}}function kt(o){switch(o){case"up":return x(0,-1);case"down":return x(0,1);case"left":return x(-1,0);case"right":return x(1,0)}}function Ct(o,t,e=wt){const i=kt(t.direction),s=e*t.deltaTime,n=vt(i,s);return Mt(o,n)}function bt(o,t,e,i){const s=i/2;return{x:Math.max(s,Math.min(t-s,o.x)),y:Math.max(s,Math.min(e-s,o.y))}}function j(o,t){const e=o.x-t.x,i=o.y-t.y;return Math.sqrt(e*e+i*i)}function ct(o,t,e,i){return j(o,e)<t+i}function Pt(o,t,e,i){return ct(o,t,e,i)}function Et(o,t,e,i=15){return ct(o,t,e,i)}const Bt={coins:{min:0,max:Number.MAX_SAFE_INTEGER},energy:{min:0,max:100},mood:{min:0,max:100},thirst:{min:0,max:100},hunger:{min:0,max:100},karma:{min:-100,max:100},speed:{min:50,max:200}};function W(o,t,e=Bt){return{coins:E(o.coins+(t.coins??0),e.coins.min,e.coins.max),energy:E(o.energy+(t.energy??0),e.energy.min,e.energy.max),mood:E(o.mood+(t.mood??0),e.mood.min,e.mood.max),thirst:E(o.thirst+(t.thirst??0),e.thirst.min,e.thirst.max),hunger:E(o.hunger+(t.hunger??0),e.hunger.min,e.hunger.max),karma:E(o.karma+(t.karma??0),e.karma.min,e.karma.max),speed:E(o.speed+(t.speed??0),e.speed.min,e.speed.max)}}function E(o,t,e){return Math.max(t,Math.min(e,o))}const F={energyDecayPerPixel:.01,moodDecayPerSecond:.1,moodDecayFromLowEnergy:.2,lowEnergyThreshold:30,thirstDecayPerSecond:.75,hungerDecayPerSecond:.5,karmaDecayPerSecond:.01};function Tt(o,t=F){return-(o*t.energyDecayPerPixel)}function Wt(o,t,e,i,s){return((t+e+i)/3-s)*2*o}function It(o,t=F){return-(o*t.thirstDecayPerSecond)}function Dt(o,t=F){return-(o*t.hungerDecayPerSecond)}function Rt(o,t,e=F){return t>0?-(o*e.karmaDecayPerSecond):t<0?o*e.karmaDecayPerSecond:0}function At(o,t,e,i=F){const s=Tt(o,i),n=Wt(t,e.energy,e.thirst,e.hunger,e.mood),r=It(t,i),a=Dt(t,i),c=Rt(t,e.karma,i);return{energy:s,mood:n,thirst:r,hunger:a,karma:c}}const lt={caffeine:{type:"caffeine",duration:10,intensity:.3,effects:{timeScale:1.2,speed:20,energy:15,thirst:-10}},alcohol:{type:"alcohol",duration:12,intensity:.5,effects:{timeScale:.8,speed:-15,mood:20,energy:-10,thirst:15}},mdma:{type:"mdma",duration:24,intensity:.8,effects:{timeScale:1.5,speed:30,mood:40,energy:25,thirst:20,hunger:-15}},lsd:{type:"lsd",duration:72,intensity:.9,effects:{timeScale:.3,mood:30,hunger:-20,thirst:-10}},mushrooms:{type:"mushrooms",duration:36,intensity:.7,effects:{timeScale:.5,mood:25,hunger:-10,karma:10}},weed:{type:"weed",duration:18,intensity:.4,effects:{timeScale:.7,mood:15,hunger:20,speed:-10}},molly:{type:"molly",duration:18,intensity:1,effects:{timeScale:.3,mood:25,energy:10,thirst:20,hunger:-5}},shrooms:{type:"shrooms",duration:48,intensity:.8,effects:{timeScale:.5,mood:25,hunger:-8,karma:8}},acid:{type:"acid",duration:45,intensity:1,effects:{timeScale:.2,mood:12,hunger:-10,thirst:-8}},dmt:{type:"dmt",duration:15,intensity:1,effects:{timeScale:.1,mood:50,energy:40,hunger:-30,thirst:-20,karma:25}},salvia:{type:"salvia",duration:12,intensity:.8,effects:{timeScale:.2,mood:20,hunger:-15,thirst:-10}},whipits:{type:"whipits",duration:5,intensity:1,effects:{timeScale:0,mood:8,energy:5}},"energy-drink":{type:"energy-drink",duration:30,intensity:.6,effects:{timeScale:2,speed:40,energy:30,thirst:-15}},"mystery-pill":{type:"mystery-pill",duration:24,intensity:.8,effects:{timeScale:.8,speed:15,mood:20,energy:15}},"mystery-snowball":{type:"mystery-snowball",duration:12,intensity:.7,effects:{timeScale:2,speed:50,energy:20,mood:10}},cigarette:{type:"cigarette",duration:5,intensity:.3,effects:{timeScale:1,mood:5,energy:-5,thirst:-5}},joint:{type:"joint",duration:18,intensity:.4,effects:{timeScale:.7,mood:15,hunger:20,thirst:15,speed:-10}},vodka:{type:"vodka",duration:24,intensity:.5,effects:{timeScale:.8,speed:-20,mood:15,energy:-15,thirst:20}},mda:{type:"mda",duration:30,intensity:.7,effects:{timeScale:.9,speed:15,mood:25,energy:20,thirst:15}},"2c-i":{type:"2c-i",duration:36,intensity:.8,effects:{timeScale:.7,mood:20,hunger:-15,thirst:-10}},cocaine:{type:"cocaine",duration:30,intensity:.9,effects:{timeScale:1.2,speed:20,mood:25,energy:30,hunger:-10,thirst:-15}},ketamine:{type:"ketamine",duration:15,intensity:.8,effects:{timeScale:.2,speed:20,mood:20,energy:15,hunger:-5,thirst:-10}},cannabis:{type:"cannabis",duration:24,intensity:.5,effects:{timeScale:.8,mood:20,hunger:25,speed:-15,energy:-5}}};function $t(o,t=1){var i,s,n,r,a,c,h;const e=lt[o];if(!e)throw new Error(`Unknown drug type: ${o}`);return{type:o,duration:e.duration,intensity:Math.min(1,Math.max(0,t)),effects:{timeScale:(i=e.effects)==null?void 0:i.timeScale,speed:(s=e.effects)==null?void 0:s.speed,energy:(n=e.effects)==null?void 0:n.energy,mood:(r=e.effects)==null?void 0:r.mood,thirst:(a=e.effects)==null?void 0:a.thirst,hunger:(c=e.effects)==null?void 0:c.hunger,karma:(h=e.effects)==null?void 0:h.karma}}}function Ft(o,t){const e=t,s=o.active.map(n=>{const r=Math.max(0,n.duration-e);return{...n,duration:r}}).filter(n=>n.duration>0);return{...o,active:s}}function Lt(o,t){if(o.active.length>=o.maxStack){const i=[...o.active].sort((s,n)=>s.duration-n.duration);return i.shift(),i.push(t),{...o,active:i}}const e=o.active.findIndex(i=>i.type===t.type);if(e!==-1){const i=o.active[e],s={...t,intensity:Math.min(1,i.intensity+t.intensity*.5),duration:i.duration+t.duration*.5},n=[...o.active];return n[e]=s,{...o,active:n}}return{...o,active:[...o.active,t]}}function st(o){let t=1;for(const e of o.active)e.effects.timeScale&&(t*=e.effects.timeScale);return t}function M(o,t){return o.active.some(e=>e.type===t&&e.duration>0)}const ht={baseSpeed:100,energyThreshold:30,thirstThreshold:30,hungerThreshold:30,moodThreshold:30,maxSpeedMultiplier:1.5,minSpeedMultiplier:.3};function Gt(o,t=ht){let e=1;if(o.energy<t.energyThreshold){const i=o.energy/t.energyThreshold;e*=.3+i*.7}else o.energy>80&&(e*=1.2);if(o.thirst<t.thirstThreshold){const i=o.thirst/t.thirstThreshold;e*=.6+i*.4}else o.thirst>80&&(e*=1.1);if(o.hunger<t.hungerThreshold){const i=o.hunger/t.hungerThreshold;e*=.7+i*.3}else o.hunger>80&&(e*=1.05);if(o.mood<t.moodThreshold){const i=o.mood/t.moodThreshold;e*=.8+i*.2}else o.mood>80&&(e*=1.05);return Math.max(t.minSpeedMultiplier,Math.min(t.maxSpeedMultiplier,e))}function dt(o,t,e=ht){const i=Gt(t,e);return o*i}const R={Water:{type:"Water",quantity:0,hotkey:"W",effects:{thirst:35,mood:3}},"Grilled Cheese":{type:"Grilled Cheese",quantity:0,hotkey:"J",effects:{hunger:25,mood:8}},"Energy Bar":{type:"Energy Bar",quantity:0,hotkey:"E",effects:{hunger:15,mood:4,energy:20}},Trinket:{type:"Trinket",quantity:0,hotkey:"T",effects:{mood:12,energy:8}},Clothing:{type:"Clothing",quantity:0,hotkey:"C",effects:{mood:15,energy:10}},"Veggie Burger":{type:"Veggie Burger",quantity:0,hotkey:"V",effects:{hunger:35,mood:10}},"Fruit Salad":{type:"Fruit Salad",quantity:0,hotkey:"F",effects:{hunger:20,mood:6}},"Pizza Slice":{type:"Pizza Slice",quantity:0,hotkey:"P",effects:{hunger:30,mood:12}},Smoothie:{type:"Smoothie",quantity:0,hotkey:"S",effects:{hunger:18,mood:5}},Popsicle:{type:"Popsicle",quantity:0,hotkey:"O",effects:{hunger:8,mood:3}},Burrito:{type:"Burrito",quantity:0,hotkey:"B",effects:{hunger:28,mood:9}},Taco:{type:"Taco",quantity:0,hotkey:"A",effects:{hunger:22,mood:7}},"Ice Cream":{type:"Ice Cream",quantity:0,hotkey:"I",effects:{hunger:12,mood:6}},"Corn Dog":{type:"Corn Dog",quantity:0,hotkey:"D",effects:{hunger:25,mood:8}},"Funnel Cake":{type:"Funnel Cake",quantity:0,hotkey:"U",effects:{hunger:20,mood:10}},Nachos:{type:"Nachos",quantity:0,hotkey:"N",effects:{hunger:24,mood:7}},"Cotton Candy":{type:"Cotton Candy",quantity:0,hotkey:"Y",effects:{hunger:5,mood:2}},"Gas Can":{type:"Gas Can",quantity:0,effects:{}}};function Nt(){return{items:new Map}}function D(o,t,e=1){const i=o.items.get(t)||0;o.items.set(t,i+e)}function Ht(o,t,e=1){const i=o.items.get(t)||0;if(i>=e){const s=i-e;return s<=0?o.items.delete(t):o.items.set(t,s),!0}return!1}function zt(o,t,e=1){return(o.items.get(t)||0)>=e}function nt(o,t,e){if(console.log("useItem called:",t,"current stats:",e),!zt(o,t,1))return console.log("useItem failed: no item in inventory"),{success:!1,newStats:e};const i=R[t];if(!i)return console.log("useItem failed: no item definition"),{success:!1,newStats:e};console.log("useItem: item effects:",i.effects),Ht(o,t,1);const s=W(e,i.effects);return console.log("useItem: new stats after applying effects:",s),{success:!0,newStats:s}}function Yt(o){const t=[];return o.items.forEach((e,i)=>{const s=R[i];t.push({type:i,quantity:e,hotkey:s==null?void 0:s.hotkey})}),t.sort((e,i)=>i.quantity-e.quantity)}class Xt{constructor(){y(this,"notifications",[]);y(this,"nextId",0)}addNotification(t,e,i,s){const n=Date.now(),r=500,a=this.notifications.find(c=>c.type===e&&c.value===i&&n-c.timestamp<r);if(a){a.count+=1,a.timestamp=n,a.alpha=1;const c=t.replace(/^\+?(\d+)/,"").trim();a.message=`+${a.count} ${c}`}else{const c={id:`notification_${this.nextId++}`,message:t,type:e,value:i,timestamp:n,duration:2e3,worldPosition:{...s},alpha:1,count:1};this.notifications.push(c)}}updateNotifications(t){const e=Date.now();this.notifications=this.notifications.filter(i=>{const n=(e-i.timestamp)/i.duration;return n>=1?!1:(i.alpha=1-n,!0)})}clearNotifications(){this.notifications=[]}getGroupedNotifications(){const t=new Map;return this.notifications.forEach(e=>{const i=`${e.type}_${e.value>0?"positive":"negative"}`;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}}function Ut(o,t){const e=C(),i=o>0?`+${o} Coin`:`${o} Coin`;e.addNotification(i,"coin",o,t)}function w(o,t,e){const i=C(),s=t>0?`+${t} ${o.charAt(0).toUpperCase()+o.slice(1)}`:`${t} ${o.charAt(0).toUpperCase()+o.slice(1)}`;i.addNotification(s,o,t,e)}function J(o,t){C().addNotification(`+1 ${o}`,"item",1,t)}let Q=null;function C(){return Q||(Q=new Xt),Q}class Ot{constructor(){y(this,"actions",[]);this.initializeDefaultActions()}initializeDefaultActions(){this.addAction({id:"rest",name:"Rest",hotkey:"R",description:"Rest to restore energy",cooldown:1e3,lastUsed:0,enabled:!0})}addAction(t){this.actions.push(t)}getActionByHotkey(t){return this.actions.find(e=>e.hotkey.toLowerCase()===t.toLowerCase())}canUseAction(t){const e=this.actions.find(s=>s.id===t);return!e||!e.enabled?!1:Date.now()-e.lastUsed>=e.cooldown}useAction(t){const e=this.actions.find(i=>i.id===t);!e||!this.canUseAction(t)||(e.lastUsed=Date.now())}}let Z=null;function qt(){return Z||(Z=new Ot),Z}const Vt={minutesPerRealSecond:60,hoursPerDay:24,minutesPerHour:60};function jt(){return{day:1,hour:8,minute:0,totalMinutes:0}}function _t(o,t,e=1,i=Vt){const n=t*i.minutesPerRealSecond*e,r=o.totalMinutes+n,a=i.hoursPerDay*i.minutesPerHour,c=Math.floor(r/a)+1,h=r%a,l=Math.floor(h/i.minutesPerHour),d=Math.floor(h%i.minutesPerHour);return{day:c,hour:l,minute:d,totalMinutes:r}}function Kt(o){const t=o.hour===0?12:o.hour>12?o.hour-12:o.hour,e=o.hour<12?"AM":"PM",i=o.minute.toString().padStart(2,"0");return`Day ${o.day} - ${t}:${i} ${e}`}function Jt(o){return o.hour>=6&&o.hour<12?"Morning":o.hour>=12&&o.hour<17?"Afternoon":o.hour>=17&&o.hour<21?"Evening":"Night"}function Qt(o,t="#f5deb3"){const e=o.hour,i=t.replace("#",""),s=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),r=parseInt(i.substr(4,2),16);let a=1;e>=6&&e<8?a=.3+(e-6)*.35:e>=8&&e<18?a=1:e>=18&&e<20?a=1-(e-18)*.35:a=.3;const c=Math.floor(s*a),h=Math.floor(n*a),l=Math.floor(r*a);return`rgb(${c}, ${h}, ${l})`}class Zt{constructor(){y(this,"worlds",new Map);this.initializeDefaultWorlds()}registerWorld(t){this.worlds.set(t.id,t)}getWorld(t){return this.worlds.get(t)}getAllWorldIds(){return Array.from(this.worlds.keys())}hasWorld(t){return this.worlds.has(t)}initializeDefaultWorlds(){this.registerWorld({id:"camp",name:"Camp",width:1600,height:1200,backgroundColor:"#f5deb3",timeScale:1,spawnPosition:x(800,600),boundaries:[{side:"left",exitWorldId:"playa",exitPosition:x(400,1500),triggerDistance:50,useRelativePositioning:!0},{side:"right",exitWorldId:"playa",exitPosition:x(400,1500),triggerDistance:50,useRelativePositioning:!0},{side:"top",exitWorldId:"playa",exitPosition:x(400,1500),triggerDistance:50,useRelativePositioning:!0},{side:"bottom",exitWorldId:"playa",exitPosition:x(400,1500),triggerDistance:50,useRelativePositioning:!0}],description:"Your home base at Burning Man"}),this.registerWorld({id:"playa",name:"The Playa",width:2400,height:1800,backgroundColor:"#f5deb3",timeScale:1,spawnPosition:x(1200,900),boundaries:[{side:"right",exitWorldId:"camp",exitPosition:x(100,600),triggerDistance:50},{side:"left",exitWorldId:"danceStage",exitPosition:x(1400,400),triggerDistance:50},{side:"area",exitWorldId:"camp",exitPosition:x(800,600),areaPosition:x(400,1500),areaWidth:100,areaHeight:75,triggerDistance:0,useRelativePositioning:!0}],description:"The vast open playa of Burning Man"}),this.registerWorld({id:"danceStage",name:"Dance Stage",width:1200,height:800,backgroundColor:"#1a1a2e",timeScale:1,spawnPosition:x(600,400),boundaries:[{side:"right",exitWorldId:"playa",exitPosition:x(100,400),triggerDistance:50}],description:"The main dance stage with pulsing lights"})}}const te=new Zt;function tt(o){return te.getWorld(o)}class ee{constructor(t){y(this,"worldStates",new Map);y(this,"storage");y(this,"storagePrefix","world_state_");this.storage=t}getWorldState(t){return this.worldStates.has(t)||this.worldStates.set(t,this.createEmptyWorldState(t)),this.worldStates.get(t)}updateWorldState(t,e){const s={...this.getWorldState(t),...e};this.worldStates.set(t,s)}addWorldItem(t,e){const i=this.getWorldState(t);i.items.push(e),this.updateWorldState(t,{items:i.items})}removeWorldItem(t,e){const i=this.getWorldState(t);i.items=i.items.filter(s=>s.id!==e),this.updateWorldState(t,{items:i.items})}updateWorldItem(t,e,i){const s=this.getWorldState(t),n=s.items.findIndex(r=>r.id===e);n!==-1&&(s.items[n]={...s.items[n],...i},this.updateWorldState(t,{items:s.items}))}addWorldNPC(t,e){const i=this.getWorldState(t);i.npcs.push(e),this.updateWorldState(t,{npcs:i.npcs})}updateWorldNPC(t,e,i){const s=this.getWorldState(t),n=s.npcs.findIndex(r=>r.id===e);n!==-1&&(s.npcs[n]={...s.npcs[n],...i},this.updateWorldState(t,{npcs:s.npcs}))}addWorldEvent(t,e){const i=this.getWorldState(t);i.events.push(e),this.updateWorldState(t,{events:i.events})}triggerWorldEvent(t,e){const i=this.getWorldState(t),s=i.events.findIndex(n=>n.id===e);s!==-1&&(i.events[s].triggered=!0,this.updateWorldState(t,{events:i.events}))}markWorldVisited(t){this.updateWorldState(t,{lastVisited:Date.now()})}markWorldLoaded(t,e){this.updateWorldState(t,{isLoaded:e})}async saveAllWorldStates(){const t=Array.from(this.worldStates.entries()).map(([e,i])=>{const s=`${this.storagePrefix}${e}`;return this.storage.save(s,JSON.stringify(i))});await Promise.all(t)}async loadAllWorldStates(){const e=["camp","playa","danceStage"].map(async i=>{const s=`${this.storagePrefix}${i}`;try{const n=await this.storage.load(s);if(n&&typeof n=="string"){const r=JSON.parse(n);this.worldStates.set(i,r)}}catch(n){console.warn(`Failed to load world state for ${i}:`,n),this.worldStates.set(i,this.createEmptyWorldState(i))}});await Promise.all(e)}createEmptyWorldState(t){return{worldId:t,items:[],npcs:[],events:[],lastVisited:Date.now(),isLoaded:!1}}getLoadedWorldIds(){return Array.from(this.worldStates.entries()).filter(([t,e])=>e.isLoaded).map(([t,e])=>t)}clearAllWorldStates(){this.worldStates.clear()}}class ie{constructor(t,e){y(this,"currentWorldId");y(this,"loadedWorlds",new Set);y(this,"worldStateManager");y(this,"transitionInProgress",!1);y(this,"lastExitDirection");y(this,"originalExitDirection");this.currentWorldId=t,this.worldStateManager=e,this.loadedWorlds.add(t)}getCurrentWorld(){return tt(this.currentWorldId)}getCurrentWorldId(){return this.currentWorldId}getState(){return{currentWorldId:this.currentWorldId,loadedWorlds:new Set(this.loadedWorlds),worldStates:new Map,transitionInProgress:this.transitionInProgress}}checkWorldTransition(t,e){if(this.transitionInProgress)return null;const i=this.getCurrentWorld();if(!i)return null;for(const s of i.boundaries){const n=this.getDistanceToBoundary(t,s,i),r=s.triggerDistance||e;if(n<=r){this.lastExitDirection=s.side,this.currentWorldId==="camp"&&(this.originalExitDirection=this.lastExitDirection);const a=this.calculateExitPosition(s,i);return this.initiateWorldTransition(s.exitWorldId,a)}}return null}getDistanceToBoundary(t,e,i){switch(e.side){case"left":return t.x;case"right":return i.width-t.x;case"top":return t.y;case"bottom":return i.height-t.y;case"area":if(e.areaPosition&&e.areaWidth&&e.areaHeight){const s=e.areaPosition.x-e.areaWidth/2,n=e.areaPosition.x+e.areaWidth/2,r=e.areaPosition.y-e.areaHeight/2,a=e.areaPosition.y+e.areaHeight/2;if(t.x>=s&&t.x<=n&&t.y>=r&&t.y<=a)return 0}return 1/0;default:return 1/0}}calculateExitPosition(t,e){if(t.useRelativePositioning){if(t.exitWorldId==="camp"&&this.originalExitDirection)return this.calculateRelativeExitPosition(t,e,this.originalExitDirection);if(this.lastExitDirection)return this.calculateRelativeExitPosition(t,e,this.lastExitDirection)}return t.exitPosition}calculateRelativeExitPosition(t,e,i){const s=t.exitPosition,n=t.exitWorldId==="playa"?150:400;switch(i){case"left":return{x:s.x-n,y:s.y};case"right":return{x:s.x+n,y:s.y};case"top":return{x:s.x,y:s.y-n};case"bottom":return{x:s.x,y:s.y+n};default:return s}}initiateWorldTransition(t,e){this.transitionInProgress=!0,this.worldStateManager.markWorldVisited(this.currentWorldId),this.loadedWorlds.has(t)||this.loadedWorlds.add(t),this.currentWorldId=t,t==="camp"&&(this.originalExitDirection=void 0),this.worldStateManager.markWorldVisited(t),this.transitionInProgress=!1;const i=tt(t),s=i?`Entering ${i.name}`:void 0;return{success:!0,newWorldId:t,newPosition:e,message:s}}getWorldStateManager(){return this.worldStateManager}isWorldLoaded(t){return this.loadedWorlds.has(t)}getLoadedWorldIds(){return Array.from(this.loadedWorlds)}forceTransitionToWorld(t,e){return tt(t)?this.initiateWorldTransition(t,e):{success:!1,newWorldId:this.currentWorldId,newPosition:e,message:`World ${t} not found`}}getCurrentTimeScale(){const t=this.getCurrentWorld();return(t==null?void 0:t.timeScale)||1}getCurrentWorldBackgroundColor(){const t=this.getCurrentWorld();return(t==null?void 0:t.backgroundColor)||"#34495e"}getCurrentWorldDimensions(){const t=this.getCurrentWorld();return{width:(t==null?void 0:t.width)||1600,height:(t==null?void 0:t.height)||1200}}}function se(o,t){switch(o){case"playa":return oe(t);case"camp":return ae();case"danceStage":return re();default:return[]}}function ne(o){return o<=1?.2:o<=2?.4:o<=3?.6:o<=4?.8:o<=5||o<=6||o<=7?1:o===8?.67:o===9?.33:.1}function ot(o,t){return t==="man"?o<=1?{progress:0,isBurning:!1,isBurned:!1}:o===2?{progress:.1,isBurning:!1,isBurned:!1}:o===3?{progress:.3,isBurning:!1,isBurned:!1}:o===4?{progress:.5,isBurning:!1,isBurned:!1}:o===5?{progress:.7,isBurning:!1,isBurned:!1}:o===6?{progress:.9,isBurning:!1,isBurned:!1}:o===7?{progress:1,isBurning:!1,isBurned:!1}:o===8?{progress:1,isBurning:!0,isBurned:!1,handsUp:!0}:o>=9?{progress:0,isBurning:!1,isBurned:!0}:{progress:0,isBurning:!1,isBurned:!1}:o<=1?{progress:0,isBurning:!1,isBurned:!1}:o===2?{progress:.15,isBurning:!1,isBurned:!1}:o===3?{progress:.35,isBurning:!1,isBurned:!1}:o===4?{progress:.55,isBurning:!1,isBurned:!1}:o===5?{progress:.75,isBurning:!1,isBurned:!1}:o===6?{progress:.9,isBurning:!1,isBurned:!1}:o===7?{progress:1,isBurning:!1,isBurned:!1}:o===8?{progress:1,isBurning:!1,isBurned:!1}:o===9?{progress:1,isBurning:!0,isBurned:!1}:o>=10?{progress:0,isBurning:!1,isBurned:!0}:{progress:0,isBurning:!1,isBurned:!1}}function oe(o){const t=[],e=(o==null?void 0:o.day)||1,i=(o==null?void 0:o.hour)??0,s=ot(e,"man"),n=e===8&&i>=20;t.push({id:"the-man",type:"man",position:x(1200,900),size:180,color:n?"#ff0000":s.isBurned?"#444444":"#ff6b35",description:n?"The Man is burning!":s.isBurned?"The Man has burned":s.handsUp?"The Man - hands raised, ready to burn!":"The Man - the center of Burning Man",buildingProgress:s.progress,isBurning:n,isBurned:s.isBurned,handsUp:s.handsUp});const r=ot(e,"temple"),a=e===9&&i>=20;return t.push({id:"the-temple",type:"temple",position:x(1200,300),size:120,color:a?"#ff0000":r.isBurned?"#444444":"#8b4513",description:a?"The Temple is burning!":r.isBurned?"The Temple has burned":"The Temple - a place of reflection and remembrance",buildingProgress:r.progress,isBurning:a,isBurned:r.isBurned}),t.push({id:"trash-fence",type:"trashFence",position:x(1200,900),size:800,color:"#2c3e50",description:"Trash fence - the perimeter of the event"}),t.push({id:"playa-camp",type:"camp",position:x(400,1500),size:100,color:"#27ae60",description:"Your camp on the playa - walk here to return to main camp"}),t}function ae(){return[]}function re(){return[{id:"main-stage",type:"artCar",position:x(600,400),size:50,color:"#9b59b6",description:"Main dance stage with pulsing lights"}]}function N(o,t,e=100){const i=Math.ceil(o/e),s=Math.ceil(t/e),n=[];for(let r=0;r<i;r++){n[r]=[];for(let a=0;a<s;a++)n[r][a]={entities:[]}}return{cellSize:e,worldWidth:o,worldHeight:t,gridWidth:i,gridHeight:s,cells:n}}function ce(o,t){return{x:Math.floor(o.x/t),y:Math.floor(o.y/t)}}function le(o,t,e,i){return o>=0&&o<e&&t>=0&&t<i}function I(o,t){const e=ce(t.position,o.cellSize);le(e.x,e.y,o.gridWidth,o.gridHeight)&&o.cells[e.x][e.y].entities.push(t)}function he(o,t){for(let e=0;e<o.gridWidth;e++)for(let i=0;i<o.gridHeight;i++){const s=o.cells[e][i],n=s.entities.findIndex(r=>r.id===t);if(n!==-1){s.entities.splice(n,1);return}}}function ut(o,t,e){const i=[];let s=0;const n=Math.max(0,Math.floor((t.x-e)/o.cellSize)),r=Math.min(o.gridWidth-1,Math.floor((t.x+e)/o.cellSize)),a=Math.max(0,Math.floor((t.y-e)/o.cellSize)),c=Math.min(o.gridHeight-1,Math.floor((t.y+e)/o.cellSize));for(let h=n;h<=r;h++)for(let l=a;l<=c;l++){s++;const d=o.cells[h][l];for(const u of d.entities){const f=u.position.x-t.x,g=u.position.y-t.y;Math.sqrt(f*f+g*g)<=e&&i.push(u)}}return{entities:i,cellsQueried:s}}function de(o,t,e,i,s){const n=[];let r=0;const a=Math.max(0,Math.floor(t/o.cellSize)),c=Math.min(o.gridWidth-1,Math.floor(i/o.cellSize)),h=Math.max(0,Math.floor(e/o.cellSize)),l=Math.min(o.gridHeight-1,Math.floor(s/o.cellSize));for(let d=a;d<=c;d++)for(let u=h;u<=l;u++){r++;const f=o.cells[d][u];for(const g of f.entities)g.position.x>=t&&g.position.x<=i&&g.position.y>=e&&g.position.y<=s&&n.push(g)}return{entities:n,cellsQueried:r}}function H(o,t,e){return`${e}_${t}_${o}`}function z(o,t,e){const i=o.x-t.x,s=o.y-t.y;return Math.sqrt(i*i+s*s)<e}function Y(o,t,e){return ut(t,o,e).entities.length>0}function X(o,t,e){return{x:o.randomRange(50,t-50),y:o.randomRange(50,e-50)}}function at(o,t){return{coin:{value:1,radius:2.4,color:"#f1c40f",borderColor:"#f39c12"},water:{value:1,radius:3,color:"#3498db",borderColor:"#2980b9"},food:{value:1,radius:4,color:"#e67e22",borderColor:"#d35400",subtypes:["Grilled Cheese","Energy Bar","Veggie Burger","Fruit Salad","Pizza Slice","Smoothie","Popsicle","Burrito","Taco","Ice Cream","Corn Dog","Funnel Cake","Nachos","Cotton Candy"]},drug:{value:1,radius:3.5,color:"#9b59b6",borderColor:"#8e44ad",subtypes:["molly","shrooms","acid","dmt","salvia","whipits","energy-drink","mystery-pill","mystery-snowball","cigarette","joint","vodka","mda","2c-i","caffeine","alcohol","mdma","lsd","mushrooms","weed","cocaine","ketamine","cannabis"]}}[o]}function ue(o,t,e,i,s,n=100,r=50,a=30,c=20){const h=[],l=(n+r+a+c)*10;let d=0;for(let u=0;u<n&&d<l;d++){const f=X(o,t,e);if(!z(f,i,100)&&!Y(f,s,40)){const g={id:H(u,o.getSeed(),"coin"),position:f,type:"coin",value:1,collected:!1};h.push(g),I(s,{id:g.id,position:g.position,radius:2.4}),u++}}for(let u=0;u<r&&d<l;d++){const f=X(o,t,e);if(!z(f,i,100)&&!Y(f,s,40)){const g={id:H(u,o.getSeed(),"water"),position:f,type:"water",value:1,collected:!1,subtype:"water-bottle"};h.push(g),I(s,{id:g.id,position:g.position,radius:3}),u++}}for(let u=0;u<a&&d<l;d++){const f=X(o,t,e);if(!z(f,i,100)&&!Y(f,s,40)){const g=at("food"),p=g.subtypes[Math.floor(o.random()*g.subtypes.length)],m={id:H(u,o.getSeed(),"food"),position:f,type:"food",value:1,collected:!1,subtype:p};h.push(m),I(s,{id:m.id,position:m.position,radius:4}),u++}}for(let u=0;u<c&&d<l;d++){const f=X(o,t,e);if(!z(f,i,100)&&!Y(f,s,40)){const g=at("drug"),p=g.subtypes[Math.floor(o.random()*g.subtypes.length)],m={id:H(u,o.getSeed(),"drug"),position:f,type:"drug",value:1,collected:!1,subtype:p};h.push(m),I(s,{id:m.id,position:m.position,radius:3.5}),u++}}return h}const q={ziptie:{emoji:"🔗",radius:8,karmaReward:2,spawnWeight:15},"water-bottle":{emoji:"🍼",radius:12,karmaReward:3,spawnWeight:20},cup:{emoji:"🥤",radius:10,karmaReward:2,spawnWeight:18},"flashing-light":{emoji:"💡",radius:14,karmaReward:5,spawnWeight:8},"furry-hat":{emoji:"🎩",radius:16,karmaReward:8,spawnWeight:5},"cigarette-butt":{emoji:"🚬",radius:6,karmaReward:1,spawnWeight:25}};function fe(){return`moop_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function ge(o){return{ziptie:"Zip Tie","water-bottle":"Water Bottle",cup:"Cup","flashing-light":"Flashing Light","furry-hat":"Furry Hat","cigarette-butt":"Cigarette Butt"}[o]}function ye(o,t,e){return j(o,t)<e}function pe(o,t,e){return t.some(i=>j(o,i.position)<e)}function xe(o,t){const e=o.random()*(t.maxX-t.minX)+t.minX,i=o.random()*(t.maxY-t.minY)+t.minY;return x(e,i)}function me(o){const t=Object.keys(q),e=t.map(n=>q[n].spawnWeight),i=e.reduce((n,r)=>n+r,0);let s=o.random()*i;for(let n=0;n<t.length;n++)if(s-=e[n],s<=0)return t[n];return t[t.length-1]}function Se(o,t,e,i){const s=[];for(let n=0;n<o.count;n++){let r=0;const a=50;let c;do c=xe(i,o.worldBounds),r++;while(r<a&&(ye(c,t,o.minDistanceFromPlayer)||pe(c,[...e,...s],o.minDistanceFromOtherMoop)));if(r<a){const h=me(i),l=q[h],d={id:fe(),type:h,position:c,radius:l.radius,karmaReward:l.karmaReward,collected:!1};s.push(d)}}return s}function we(o,t,e,i){const s=o.x-e.x,n=o.y-e.y;return Math.sqrt(s*s+n*n)<t+i}function Me(o,t){if(o.collected)return{success:!1,collectedMoop:null,karmaGained:0,newStats:t};const e=o.karmaReward,i=W(t,{karma:e});return{success:!0,collectedMoop:{...o,collected:!0},karmaGained:e,newStats:i}}function ve(o,t,e){return e.filter(i=>!i.collected&&we(o,t,i.position,i.radius))}function ke(o){var t;return((t=q[o])==null?void 0:t.emoji)||"🗑️"}function Ce(o){return{coins:o,energy:0,mood:0}}function be(o,t){return{coins:0,energy:o,mood:t}}function Pe(o){return{success:!0,statDelta:Ce(o),message:`Picked up ${o} coin${o>1?"s":""}!`}}function Ee(o=20,t=10){return{success:!0,statDelta:be(o,t),message:"You feel refreshed!"}}function Be(o){const t={position:x(0,0),zoom:o.zoom,viewport:{x:0,y:0,width:o.viewportWidth,height:o.viewportHeight},followSpeed:o.followSpeed,worldBounds:o.worldBounds};return ft(t),t}function ft(o){const t=o.viewport.width/2,e=o.viewport.height/2;o.viewport.x=o.position.x-t,o.viewport.y=o.position.y-e}function S(o,t){const e=(o.x-t.viewport.x)*t.zoom,i=(o.y-t.viewport.y)*t.zoom;return x(e,i)}function v(o,t,e=0){const i=t.viewport.x-e,s=t.viewport.x+t.viewport.width+e,n=t.viewport.y-e,r=t.viewport.y+t.viewport.height+e;return o.x>=i&&o.x<=s&&o.y>=n&&o.y<=r}function V(o,t){let e=t.x,i=t.y;if(o.worldBounds){const s=o.viewport.width/2,n=o.viewport.height/2;e=Math.max(o.worldBounds.minX+s,Math.min(o.worldBounds.maxX-s,e)),i=Math.max(o.worldBounds.minY+n,Math.min(o.worldBounds.maxY-n,i))}o.position=x(e,i),ft(o)}function Te(o,t,e,i){const s=o.position,n=t,r=n.x-s.x,a=n.y-s.y,c=Math.sqrt(r*r+a*a);if(c<1){V(o,n);return}const h=i*e,l=Math.min(h/c,1),d=s.x+r*l,u=s.y+a*l;V(o,x(d,u))}class We{constructor(t,e){y(this,"ctx");y(this,"config");y(this,"canvas");y(this,"muteButtonBounds",null);y(this,"inventoryItemBounds",[]);const i=t.getContext("2d");if(!i)throw new Error("Failed to get 2D context from canvas");this.ctx=i,this.config=e,this.canvas=t,t.width=e.canvasWidth,t.height=e.canvasHeight,this.setupMouseEvents()}setupMouseEvents(){this.canvas.addEventListener("click",t=>{const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top;if(this.muteButtonBounds&&i>=this.muteButtonBounds.x&&i<=this.muteButtonBounds.x+this.muteButtonBounds.width&&s>=this.muteButtonBounds.y&&s<=this.muteButtonBounds.y+this.muteButtonBounds.height){window.dispatchEvent(new CustomEvent("toggleMute"));return}for(const n of this.inventoryItemBounds)if(i>=n.x&&i<=n.x+n.width&&s>=n.y&&s<=n.y+n.height){window.dispatchEvent(new CustomEvent("useInventoryItem",{detail:{itemType:n.itemType}}));return}})}clear(t="#2c3e50"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.config.canvasWidth,this.config.canvasHeight)}renderPlayer(t,e,i=!1,s=50){const{playerSize:n}=this.config,r=n/2;if(!v(t,e,r))return;const a=S(t,e),c=n*e.zoom;this.ctx.fillStyle="#ff6b35",this.ctx.fillRect(a.x-c/2,a.y-c/2,c,c),this.ctx.strokeStyle="#e55a2b",this.ctx.lineWidth=2*e.zoom,this.ctx.strokeRect(a.x-c/2,a.y-c/2,c,c),this.drawWombatFeatures(a,c,e.zoom,i,s)}calculateDrugSpeedMultiplier(t){let e=1;for(const i of t.active)i.effects.speed&&(e+=i.effects.speed*i.intensity/100);return Math.max(.1,e)}drawWombatFeatures(t,e,i,s=!1,n=50){const r=Date.now()*.001,a=Math.sin(r*2)*.5+.5,c=!s&&a<.1;let h="normal";n>=80?h="happy":n>=60?h="normal":n>=40?h="worried":n>=20?h="sad":h="very_sad",this.ctx.fillStyle="#ff6b35";const l=e*.25,d=e*.35;if(this.ctx.fillRect(t.x-e*.4,t.y-e*.6,l,d),this.ctx.fillRect(t.x+e*.15,t.y-e*.6,l,d),s){this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=2;const f=e*.24;this.ctx.beginPath(),this.ctx.moveTo(t.x-e*.2-f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x-e*.2+f/2,t.y-e*.1+f/2),this.ctx.moveTo(t.x-e*.2+f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x-e*.2-f/2,t.y-e*.1+f/2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t.x+e*.2-f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x+e*.2+f/2,t.y-e*.1+f/2),this.ctx.moveTo(t.x+e*.2+f/2,t.y-e*.1-f/2),this.ctx.lineTo(t.x+e*.2-f/2,t.y-e*.1+f/2),this.ctx.stroke()}else{const f=e*.3;let g=c?e*.05:e*.2,p=c?0:e*.08;h==="happy"&&!c?(g=e*.12,p=e*.05):h==="worried"&&!c?(g=e*.2,p=e*.08):h==="sad"&&!c?(g=e*.12,p=e*.06):h==="very_sad"&&!c&&(g=e*.08,p=e*.04),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x-e*.2-f/2,t.y-e*.1-g/2,f,g),c||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x-e*.2,t.y-e*.1,p,0,Math.PI*2),this.ctx.fill()),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(t.x+e*.2-f/2,t.y-e*.1-g/2,f,g),c||(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(t.x+e*.2,t.y-e*.1,p,0,Math.PI*2),this.ctx.fill())}this.ctx.fillStyle="#2c3e50";const u=e*.15;this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y+e*.05),this.ctx.lineTo(t.x-u/2,t.y+e*.2),this.ctx.lineTo(t.x+u/2,t.y+e*.2),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=3,this.ctx.beginPath(),n>=80?this.ctx.arc(t.x,t.y+e*.35,e*.15,0,Math.PI):n>=60?(this.ctx.moveTo(t.x-e*.1,t.y+e*.35),this.ctx.lineTo(t.x+e*.1,t.y+e*.35)):n>=40?this.ctx.arc(t.x,t.y+e*.4,e*.1,Math.PI,0):n>=20?this.ctx.arc(t.x,t.y+e*.45,e*.12,Math.PI,0):this.ctx.arc(t.x,t.y+e*.5,e*.15,Math.PI,0),this.ctx.stroke()}renderCoin(t,e,i){if(!v(t,i,2.4))return;const n=S(t,i),r=2.4*i.zoom;this.ctx.fillStyle="#f1c40f",this.ctx.beginPath(),this.ctx.arc(n.x,n.y,r,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#f39c12",this.ctx.lineWidth=1*i.zoom,this.ctx.stroke()}renderMoop(t,e){if(!v(t.position,e,t.radius))return;const i=S(t.position,e),s=16*e.zoom,n=ke(t.type);this.ctx.font=`${s}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(n,i.x,i.y)}renderCollectible(t,e,i,s){if(!v(t,s,20))return;const n=S(t,s),r=20*s.zoom;let a;switch(e){case"coin":return;case"water":a="💧";break;case"food":a=this.getFoodEmoji(i);break;case"drug":a=this.getDrugEmoji(i);break;default:a="📦"}e==="drug"?(this.ctx.shadowColor="#9b59b6",this.ctx.shadowBlur=30*s.zoom,this.ctx.font=`${r}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,n.x,n.y),this.ctx.shadowColor="#e74c3c",this.ctx.shadowBlur=15*s.zoom,this.ctx.fillText(a,n.x,n.y),this.ctx.shadowBlur=0,this.ctx.fillText(a,n.x,n.y)):(this.ctx.font=`${r}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(a,n.x,n.y))}getFoodEmoji(t){return{"Grilled Cheese":"🧀","Energy Bar":"⚡","Veggie Burger":"🍔","Fruit Salad":"🥗","Pizza Slice":"🍕",Smoothie:"🥤",Popsicle:"🍭",Burrito:"🌯",Taco:"🌮","Ice Cream":"🍦","Corn Dog":"🌭","Funnel Cake":"🧇",Nachos:"🌮","Cotton Candy":"🍬"}[t||""]||"🍎"}getDrugEmoji(t){return{molly:"💊",shrooms:"🍄",acid:"🧪",dmt:"💫",salvia:"🌿",whipits:"🎈","energy-drink":"☕","mystery-pill":"💊","mystery-snowball":"❄️",cigarette:"🚬",joint:"🚬",vodka:"🍺",mda:"💊","2c-i":"🧪",caffeine:"☕",alcohol:"🍺",mdma:"💊",lsd:"🧪",mushrooms:"🍄",weed:"🌿",cocaine:"⚪",ketamine:"⚪",cannabis:"🌿"}[t||""]||"💊"}renderStatBar(t,e,i,s,n,r,a,c){this.ctx.fillStyle="#34495e",this.ctx.fillRect(t,e,i,s);const h=Math.max(0,Math.min(1,n/r)),l=i*h;this.ctx.fillStyle=a,this.ctx.fillRect(t,e,l,s),this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=1,this.ctx.strokeRect(t,e,i,s),this.ctx.fillStyle="#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText(`${c}: ${Math.floor(n)}/${r}`,t,e-5)}renderWorldBounds(t){if(!t.worldBounds)return;const e=S({x:t.worldBounds.minX,y:t.worldBounds.minY},t),i=S({x:t.worldBounds.maxX,y:t.worldBounds.maxY},t);this.ctx.strokeStyle="#e74c3c",this.ctx.lineWidth=3*t.zoom,this.ctx.strokeRect(e.x,e.y,i.x-e.x,i.y-e.y)}renderHUD(t,e,i,s,n){const r=this.config.canvasWidth,a=this.config.canvasHeight;this.renderInventoryPanel(10,50,t.player.inventory),this.renderMuteButton(10,300,i||!1);const c=r-200,h=10,l=180,d=200;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(c,h,l,d),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=1,this.ctx.strokeRect(c,h,l,d);let u=h+15;this.renderStatBar(c+10,u,150,12,t.player.stats.thirst,100,"#3498db","Thirst"),u+=18,this.renderStatBar(c+10,u,150,12,t.player.stats.hunger,100,"#e67e22","Hunger"),u+=18,this.renderStatBar(c+10,u,150,12,t.player.stats.energy,100,"#f1c40f","Energy"),u+=18,this.renderStatBar(c+10,u,150,12,t.player.stats.mood,100,"#9b59b6","Mood"),u+=30,this.ctx.fillStyle="#ecf0f1",this.ctx.font="14px Arial",this.ctx.textAlign="left",this.ctx.fillText(`Coins: ${t.player.stats.coins}`,c+10,u),u+=18,this.ctx.fillText(`Karma: ${Math.round(t.player.stats.karma)}`,c+10,u),u+=18;const f=this.calculateDrugSpeedMultiplier(t.player.drugs),p=dt(t.player.stats.speed,t.player.stats)*f;if(this.ctx.fillText(`Speed: ${(p/100).toFixed(1)}x`,c+10,u),u+=18,s!==void 0&&this.ctx.fillText(`Time: ${s.toFixed(1)}x`,c+10,u),u+=18,this.ctx.fillText(`Game Time: ${Kt(t.time)}`,c+10,u),u+=18,this.ctx.fillText(`Period: ${Jt(t.time)}`,c+10,u),n&&n.length>0){u+=25;const m=u,b=n.length*20+10;this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.fillRect(c,m,l,b),this.ctx.strokeStyle="#e74c3c",this.ctx.lineWidth=2,this.ctx.strokeRect(c,m,l,b),this.ctx.fillStyle="#e74c3c",this.ctx.font="bold 12px Arial",this.ctx.textAlign="left",this.ctx.fillText("Active Effects:",c+10,m+15),n.forEach((k,L)=>{const P=m+25+L*18,G=`${Math.ceil(k.duration)}s`;this.ctx.fillStyle="#f1c40f",this.ctx.font="11px Arial",this.ctx.fillText(`${k.type.toUpperCase()}: ${G}`,c+10,P)})}e&&(this.ctx.textAlign="left",this.ctx.fillText(`Camera: (${Math.floor(e.position.x)}, ${Math.floor(e.position.y)})`,10,a-40),this.ctx.fillText(`Viewport: (${Math.floor(e.viewport.x)}, ${Math.floor(e.viewport.y)})`,10,a-20))}renderInventoryPanel(t,e,i){const s=Yt(i),n=30+s.length*25;this.inventoryItemBounds=[],this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(t,e,200,n),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,200,n),this.ctx.fillStyle="#8b5cf6",this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText("🎒 Inventory",t+10,e+20);let r=e+40;s.forEach(a=>{this.inventoryItemBounds.push({x:t+5,y:r-15,width:190,height:20,itemType:a.type}),this.ctx.fillStyle="rgba(139, 92, 246, 0.3)",this.ctx.fillRect(t+5,r-15,190,20),this.ctx.strokeStyle="#a855f7",this.ctx.lineWidth=1,this.ctx.strokeRect(t+5,r-15,190,20);const c=this.getItemEmoji(a.type);this.ctx.fillStyle="#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="left";const h=a.hotkey?`${c} [${a.hotkey}] ${a.type}`:`${c} ${a.type}`;this.ctx.fillText(h,t+10,r-2),this.ctx.fillStyle="rgba(0, 0, 0, 0.6)",this.ctx.fillRect(t+150,r-12,30,14),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=1,this.ctx.strokeRect(t+150,r-12,30,14),this.ctx.fillStyle="#ecf0f1",this.ctx.font="10px Arial",this.ctx.textAlign="center",this.ctx.fillText(a.quantity.toString(),t+165,r-2),r+=25})}getItemEmoji(t){return{Water:"💧","Grilled Cheese":"🧀","Energy Bar":"⚡",Trinket:"✨",Clothing:"👕","Veggie Burger":"🍔","Fruit Salad":"🥗","Pizza Slice":"🍕",Smoothie:"🥤",Popsicle:"🍭",Burrito:"🌯",Taco:"🌮","Ice Cream":"🍦","Corn Dog":"🌭","Funnel Cake":"🧇",Nachos:"🌽","Cotton Candy":"🍬","Gas Can":"⛽"}[t]||"📦"}renderNotifications(t){[...C().notifications].sort((n,r)=>r.timestamp-n.timestamp).forEach((n,r)=>{if(!v(n.worldPosition,t))return;const a=S(n.worldPosition,t),c=r*30,h=a.y-c,l=this.getNotificationColor(n.type,n.value);this.ctx.strokeStyle=`rgba(0, 0, 0, ${n.alpha*.8})`,this.ctx.lineWidth=2,this.ctx.font="bold 20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeText(n.message,a.x,h),this.ctx.fillStyle=`${l}${Math.floor(255*n.alpha).toString(16).padStart(2,"0")}`,this.ctx.fillText(n.message,a.x,h)})}renderCampEffects(t){this.ctx.strokeStyle="#808080",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]);const e={x:50,y:50,width:1500,height:1100},i=S({x:e.x,y:e.y},t),s=S({x:e.x+e.width,y:e.y+e.height},t);this.ctx.strokeRect(i.x,i.y,s.x-i.x,s.y-i.y),this.ctx.setLineDash([]),this.renderCampTents(t)}renderCampTents(t){[{x:200,y:200},{x:400,y:300},{x:600,y:150},{x:800,y:250},{x:1e3,y:180},{x:1200,y:320},{x:1400,y:200},{x:300,y:500},{x:500,y:600},{x:700,y:550},{x:900,y:650},{x:1100,y:580},{x:1300,y:620}].forEach(i=>{if(v(i,t,30)){const s=S(i,t),n=80*t.zoom;this.ctx.font=`${n}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("⛺",s.x,s.y)}})}renderPlayaEffects(t){this.ctx.strokeStyle="#808080",this.ctx.lineWidth=1,this.ctx.setLineDash([3,3]);const e={x:0,y:0,width:2400,height:1800},i=S({x:e.x,y:e.y},t),s=S({x:e.x+e.width,y:e.y+e.height},t);this.ctx.strokeRect(i.x,i.y,s.x-i.x,s.y-i.y),this.ctx.setLineDash([]),this.renderTents(t),this.renderPlayaCamps(t);const n=Date.now()*.001,r={x:400,y:1500},a=S(r,t);if(v(r,t,50)){const h=60*(1+Math.sin(n*3)*.3)*t.zoom;this.ctx.font=`${h}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("🪩",a.x,a.y)}}renderTents(t){[{x:400,y:300},{x:1800,y:400},{x:600,y:1400},{x:2e3,y:1500},{x:300,y:800},{x:2100,y:1e3}].forEach(i=>{if(v(i,t,30)){const s=S(i,t),n=20*t.zoom;this.ctx.font=`${n}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("⛺",s.x,s.y)}})}renderPlayaCamps(t){[{x:300,y:400},{x:1900,y:500},{x:500,y:1500},{x:2100,y:1600},{x:400,y:900},{x:2e3,y:1100},{x:1500,y:300},{x:800,y:1600}].forEach(i=>{if(v(i,t,30)){const s=S(i,t),n=25*t.zoom;this.ctx.font=`${n}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("🏕️",s.x,s.y)}})}renderActionPanel(t){const i=this.config.canvasHeight-120,s=200,n=100;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(10,i,s,n),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=2,this.ctx.strokeRect(10,i,s,n),this.ctx.fillStyle="#ecf0f1",this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.fillText("Actions",20,i+20);const r=i+40,a=30;this.ctx.fillStyle=t?"rgba(46, 204, 113, 0.3)":"rgba(52, 73, 94, 0.3)",this.ctx.fillRect(20,r,s-20,a),this.ctx.strokeStyle=t?"#2ecc71":"#34495e",this.ctx.lineWidth=1,this.ctx.strokeRect(20,r,s-20,a),this.ctx.fillStyle=t?"#2ecc71":"#ecf0f1",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText("Rest [R]",25,r+20),t&&(this.ctx.fillStyle="#2ecc71",this.ctx.font="10px Arial",this.ctx.textAlign="right",this.ctx.fillText("ACTIVE",10+s-15,r+20))}getNotificationColor(t,e){const i=e>0;switch(t){case"coin":return i?"#f1c40f":"#e74c3c";case"thirst":return i?"#3498db":"#e74c3c";case"hunger":return i?"#e67e22":"#e74c3c";case"energy":return i?"#f1c40f":"#e74c3c";case"mood":return i?"#9b59b6":"#e74c3c";case"karma":return i?"#27ae60":"#e74c3c";case"speed":return i?"#1abc9c":"#e74c3c";case"item":return"#8b5cf6";default:return i?"#27ae60":"#e74c3c"}}renderMuteButton(t,e,i){this.muteButtonBounds={x:t,y:e,width:30,height:50},this.ctx.fillStyle=i?"#e74c3c":"#27ae60",this.ctx.fillRect(t,e,30,30),this.ctx.strokeStyle="#ecf0f1",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,30,30),this.ctx.fillStyle="#ecf0f1",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i?"🔇":"🔊",t+30/2,e+30/2),this.ctx.font="12px Arial",this.ctx.fillText("M",t+30/2,e+30+15)}renderFireEffects(t,e){const i=Date.now()*.001;for(let s=0;s<8;s++){const n=s/8*Math.PI*2,r=e*.8+Math.sin(i*3+s)*e*.2,a=t.x+Math.cos(n)*r,c=t.y+Math.sin(n)*r-Math.sin(i*5+s)*20;this.ctx.fillStyle=`hsl(${20+Math.sin(i*2+s)*20}, 100%, ${50+Math.sin(i*4+s)*30}%)`,this.ctx.beginPath(),this.ctx.arc(a,c,3+Math.sin(i*3+s)*2,0,Math.PI*2),this.ctx.fill()}if(Math.sin(i*2)>.8)for(let s=0;s<12;s++){const n=s/12*Math.PI*2,r=e*2+Math.sin(i*4+s)*e,a=t.x+Math.cos(n)*r,c=t.y+Math.sin(n)*r;this.ctx.fillStyle=`hsl(${s*30}, 100%, 60%)`,this.ctx.beginPath(),this.ctx.arc(a,c,2,0,Math.PI*2),this.ctx.fill()}}renderTheMan(t,e,i,s,n){const r=t.x,a=t.y,c=e;if(this.ctx.save(),i>.05){this.ctx.fillStyle="#8B4513",this.ctx.fillRect(r-c*.3,a+c*.15,c*.6,c*.1),this.ctx.strokeRect(r-c*.3,a+c*.15,c*.6,c*.1),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let l=0;l<5;l++){const d=r-c*.25+l*c*.125;this.ctx.beginPath(),this.ctx.moveTo(d,a+c*.15),this.ctx.lineTo(d,a+c*.25),this.ctx.stroke()}}if(i>.15){const l=c*.8*Math.min((i-.15)*1.5,1);this.ctx.fillStyle="#654321",this.ctx.fillRect(r-c*.05,a+c*.5-l,c*.1,l),this.ctx.strokeRect(r-c*.05,a+c*.5-l,c*.1,l),this.ctx.strokeStyle="#4A2C17",this.ctx.lineWidth=1;for(let d=0;d<Math.floor(l/20);d++){const u=a+c*.5-l+d*20;this.ctx.beginPath(),this.ctx.moveTo(r-c*.05,u),this.ctx.lineTo(r+c*.05,u),this.ctx.stroke()}}if(i>.45){const l=Math.min((i-.45)*2,1);this.ctx.fillStyle="#FF6B35",this.ctx.fillRect(r-c*.08*l,a-c*.3*l,c*.16*l,c*.4*l),this.ctx.strokeRect(r-c*.08*l,a-c*.3*l,c*.16*l,c*.4*l),this.ctx.strokeStyle="#E55A2B",this.ctx.lineWidth=2;for(let d=0;d<4;d++){const u=a-c*.3*l+d*c*.1*l;this.ctx.beginPath(),this.ctx.moveTo(r-c*.08*l,u),this.ctx.lineTo(r+c*.08*l,u),this.ctx.stroke()}this.ctx.beginPath(),this.ctx.arc(r,a-c*.4*l,c*.08*l,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#000000",this.ctx.beginPath(),this.ctx.arc(r-c*.03*l,a-c*.42*l,2,0,Math.PI*2),this.ctx.arc(r+c*.03*l,a-c*.42*l,2,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=4,this.ctx.beginPath(),n?(this.ctx.moveTo(r-c*.08*l,a-c*.1*l),this.ctx.lineTo(r-c*.15*l,a-c*.25*l),this.ctx.moveTo(r+c*.08*l,a-c*.1*l),this.ctx.lineTo(r+c*.15*l,a-c*.25*l)):(this.ctx.moveTo(r-c*.08*l,a-c*.1*l),this.ctx.lineTo(r-c*.25*l,a-c*.05*l),this.ctx.moveTo(r+c*.08*l,a-c*.1*l),this.ctx.lineTo(r+c*.25*l,a-c*.05*l)),this.ctx.stroke(),this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.moveTo(r-c*.05*l,a+c*.1*l),this.ctx.lineTo(r-c*.1*l,a+c*.3*l),this.ctx.moveTo(r+c*.05*l,a+c*.1*l),this.ctx.lineTo(r+c*.1*l,a+c*.3*l),this.ctx.stroke()}if(i>.65){const l=Math.min((i-.65)*3,1);this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.arc(r,a-c*.5*l,c*.02*l,0,Math.PI*2),this.ctx.fill()}if(i>.85){const l=Math.min((i-.85)*6,1);this.ctx.fillStyle="#FFD700";for(let d=0;d<8;d++){const u=d/8*Math.PI*2,f=r+Math.cos(u)*c*.7*l,g=a+c*.3+Math.sin(u)*c*.1*l;this.ctx.beginPath(),this.ctx.arc(f,g,c*.01*l,0,Math.PI*2),this.ctx.fill()}}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.font="bold 16px Arial",this.ctx.textAlign="center";const h=`${Math.round(i*100)}%`;this.ctx.strokeText(h,r,a-c*.7),this.ctx.fillText(h,r,a-c*.7),n&&(this.ctx.fillStyle="#FF0000",this.ctx.font="bold 14px Arial",this.ctx.fillText("HANDS UP!",r,a-c*.8)),this.ctx.restore()}renderTheTemple(t,e,i,s){const n=t.x,r=t.y,a=e;if(this.ctx.save(),i>.1){this.ctx.fillStyle="#8B4513",this.ctx.fillRect(n-a*.8,r+a*.4,a*1.6,a*.15),this.ctx.strokeRect(n-a*.8,r+a*.4,a*1.6,a*.15),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=1;for(let h=0;h<8;h++)for(let l=0;l<3;l++){const d=n-a*.7+h*a*.2,u=r+a*.4+l*a*.05;this.ctx.strokeRect(d,u,a*.18,a*.04)}}if(i>.2){const h=a*.3*Math.min((i-.2)*2,1);this.ctx.fillStyle="#D2B48C",this.ctx.fillRect(n-a*.6,r+a*.25-h,a*1.2,h),this.ctx.strokeRect(n-a*.6,r+a*.25-h,a*1.2,h),this.ctx.strokeStyle="#B8860B",this.ctx.lineWidth=2;for(let l=0;l<6;l++){const d=r+a*.25-h+l*a*.05;this.ctx.beginPath(),this.ctx.moveTo(n-a*.6,d),this.ctx.lineTo(n+a*.6,d),this.ctx.stroke()}for(let l=0;l<5;l++){const d=n-a*.5+l*a*.25;this.ctx.beginPath(),this.ctx.moveTo(d,r+a*.25-h),this.ctx.lineTo(d,r+a*.25),this.ctx.stroke()}}if(i>.4){const h=Math.min((i-.4)*3,1);this.ctx.fillStyle="#000000",this.ctx.fillRect(n-a*.15*h,r+a*.25-a*.3*h,a*.3*h,a*.2*h),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(n,r+a*.15-a*.3*h,a*.15*h,0,Math.PI),this.ctx.stroke()}if(i>.6){const h=a*.4*Math.min((i-.6)*2.5,1);this.ctx.fillStyle="#F5DEB3",this.ctx.fillRect(n-a*.5,r+a*.25-a*.3-h,a*1,h),this.ctx.strokeRect(n-a*.5,r+a*.25-a*.3-h,a*1,h),this.ctx.strokeStyle="#D2B48C",this.ctx.lineWidth=1;for(let l=0;l<5;l++){const d=r+a*.25-a*.3-h+l*a*.08;this.ctx.beginPath(),this.ctx.moveTo(n-a*.5,d),this.ctx.lineTo(n+a*.5,d),this.ctx.stroke()}for(let l=0;l<3;l++){const d=n-a*.3+l*a*.3,u=r+a*.25-a*.3-h*.5;this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(d-a*.05,u-a*.08,a*.1,a*.16),this.ctx.strokeRect(d-a*.05,u-a*.08,a*.1,a*.16),this.ctx.strokeStyle="#8B4513",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(d,u-a*.08),this.ctx.lineTo(d,u+a*.08),this.ctx.moveTo(d-a*.05,u),this.ctx.lineTo(d+a*.05,u),this.ctx.stroke()}}if(i>.8){const h=Math.min((i-.8)*5,1);this.ctx.fillStyle="#8B4513",this.ctx.beginPath(),this.ctx.moveTo(n,r-a*.4*h),this.ctx.lineTo(n-a*.5,r+a*.25-a*.3-a*.4*h),this.ctx.lineTo(n+a*.5,r+a*.25-a*.3-a*.4*h),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=1;for(let l=0;l<8;l++){const d=r-a*.4*h+l*a*.05*h,u=a*.5*(1-l/8)*h;this.ctx.beginPath(),this.ctx.moveTo(n-u,d),this.ctx.lineTo(n+u,d),this.ctx.stroke()}}if(i>.9){const h=Math.min((i-.9)*10,1);this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.moveTo(n,r-a*.4),this.ctx.lineTo(n-a*.08*h,r-a*.7*h),this.ctx.lineTo(n+a*.08*h,r-a*.7*h),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle="#FFA500",this.ctx.beginPath(),this.ctx.arc(n,r-a*.7*h,a*.02*h,0,Math.PI*2),this.ctx.fill();for(let l=0;l<4;l++){const d=l/4*Math.PI*2,u=n+Math.cos(d)*a*.5,f=r+a*.25-a*.3-a*.4+Math.sin(d)*a*.1;this.ctx.fillStyle="#FFD700",this.ctx.beginPath(),this.ctx.moveTo(u,f),this.ctx.lineTo(u-a*.03*h,f-a*.15*h),this.ctx.lineTo(u+a*.03*h,f-a*.15*h),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}}if(i>=1){this.ctx.fillStyle="#FFD700";for(let h=0;h<12;h++){const l=h/12*Math.PI*2,d=n+Math.cos(l)*a*.8,u=r+a*.4+Math.sin(l)*a*.1;this.ctx.beginPath(),this.ctx.arc(d,u,a*.015,0,Math.PI*2),this.ctx.fill()}this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2;for(let h=0;h<4;h++){const l=h/4*Math.PI*2,d=n+Math.cos(l)*a*.6,u=r+a*.25-a*.3-a*.4;this.ctx.beginPath(),this.ctx.moveTo(d,u),this.ctx.lineTo(d+Math.cos(l)*a*.2,u-a*.1),this.ctx.stroke()}}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.font="bold 16px Arial",this.ctx.textAlign="center";const c=`${Math.round(i*100)}%`;this.ctx.strokeText(c,n,r-a*.9),this.ctx.fillText(c,n,r-a*.9),this.ctx.restore()}renderLandmarks(t,e){t.forEach(i=>{if(i.type==="trashFence"){if(!v(i.position,e,i.size))return}else if(!v(i.position,e))return;const s=S(i.position,e);switch(this.ctx.fillStyle=i.color,this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,i.type){case"man":const n=i.buildingProgress||1,r=i.size*n;i.isBurning&&this.renderFireEffects(s,i.size),n>0&&this.renderTheMan(s,r,n,i.isBurning||!1,i.handsUp||!1);break;case"temple":const a=i.buildingProgress||1,c=i.size*a;i.isBurning&&this.renderFireEffects(s,i.size),a>0&&this.renderTheTemple(s,c,a,i.isBurning||!1);break;case"trashFence":this.ctx.strokeStyle="#2c3e50",this.ctx.lineWidth=8,this.ctx.setLineDash([20,10]),this.ctx.beginPath(),this.ctx.arc(s.x,s.y,i.size,0,Math.PI*2),this.ctx.stroke(),this.ctx.setLineDash([]);break;case"camp":if(i.id==="playa-camp"){const d=s.x-50,u=s.y-75/2;this.ctx.fillStyle="#f5deb3",this.ctx.fillRect(d,u,100,75),this.ctx.strokeStyle="#808080",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(d,u,100,75),this.ctx.setLineDash([]),this.ctx.fillStyle="#8b4513",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("BOOM BOOM WOMB",s.x,s.y-10),this.ctx.font="20px Arial",this.ctx.fillText("🏕️",s.x,s.y+10)}else this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y-i.size/2),this.ctx.lineTo(s.x-i.size/2,s.y+i.size/2),this.ctx.lineTo(s.x+i.size/2,s.y+i.size/2),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();break;case"artCar":this.ctx.fillRect(s.x-i.size/2,s.y-i.size/2,i.size,i.size),this.ctx.strokeRect(s.x-i.size/2,s.y-i.size/2,i.size,i.size);break}})}render(t,e,i,s,n,r,a,c,h,l,d){if(this.clear(s),this.renderWorldBounds(e),h==="playa"?this.renderPlayaEffects(e):h==="camp"&&this.renderCampEffects(e),n&&this.renderLandmarks(n,e),i){const u={minX:e.viewport.x,minY:e.viewport.y,maxX:e.viewport.x+e.viewport.width,maxY:e.viewport.y+e.viewport.height};de(i,u.minX,u.minY,u.maxX,u.maxY).entities.forEach(g=>{const p=t.coins.find(m=>m.id===g.id);p&&!p.collected&&this.renderCoin(p.position,p.value,e)})}else t.coins.forEach(u=>{u.collected||this.renderCoin(u.position,u.value,e)});l&&l.forEach(u=>{var f;u.collected||this.renderCollectible(u.position,u.type,(f=u.data)==null?void 0:f.subtype,e)}),d&&d.forEach(u=>{u.collected||this.renderMoop(u,e)}),this.renderPlayer(t.player.position,e,t.player.isResting,t.player.stats.mood),this.renderDrugEffects(t.player.position,e,t.player.drugs),this.renderNotifications(e)}renderDrugEffects(t,e,i){i&&i.active&&i.active.length>0,M(i,"molly")&&this.renderMollyHearts(t,e),M(i,"mda")&&this.renderMDAHearts(t,e),M(i,"mdma")&&this.renderMDMAHearts(t,e),M(i,"shrooms")&&this.renderShroomsColorShift(),M(i,"acid")&&this.renderAcidEffects(t,e),M(i,"lsd")&&this.renderLSDEffects(t,e),M(i,"whipits")&&this.renderWhipitsVignetting(e),M(i,"dmt")&&this.renderDMTEffects(t,e),(M(i,"cannabis")||M(i,"weed")||M(i,"joint"))&&this.renderCannabisEffects(t,e)}renderMollyHearts(t,e){const i=S(t,e),s=Date.now()*.001;for(let n=0;n<8;n++){const r=n/8*Math.PI*2+s*.5,a=30+Math.sin(s*2+n)*10,c=i.x+Math.cos(r)*a,h=i.y+Math.sin(r)*a,l=(n*45+s*50)%360;this.ctx.fillStyle=`hsl(${l}, 100%, 70%)`,this.ctx.font="20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💖",c,h)}}renderMDAHearts(t,e){const i=S(t,e),s=Date.now()*.001;for(let n=0;n<4;n++){const r=n/4*Math.PI*2+s*.5,a=35+Math.sin(s*1.5+n)*8,c=i.x+Math.cos(r)*a,h=i.y+Math.sin(r)*a,l=.7+Math.sin(s*2+n)*.3;this.ctx.fillStyle=`rgba(255, ${Math.floor(192*l)}, ${Math.floor(203*l)}, 0.8)`,this.ctx.font="18px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💕",c,h)}}renderMDMAHearts(t,e){const i=S(t,e),s=Date.now()*.001;for(let n=0;n<5;n++){const r=n/5*Math.PI*2+s*.4,a=40+Math.sin(s*1.8+n)*12,c=i.x+Math.cos(r)*a,h=i.y+Math.sin(r)*a,l=.6+Math.sin(s*1.5+n)*.4;this.ctx.fillStyle=`rgba(${Math.floor(128*l)}, 0, ${Math.floor(255*l)}, 0.9)`,this.ctx.font="22px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("💜",c,h)}}renderShroomsColorShift(){const t=Date.now()*.001,e=this.ctx.createRadialGradient(this.canvas.width/2,this.canvas.height/2,0,this.canvas.width/2,this.canvas.height/2,Math.max(this.canvas.width,this.canvas.height)/2),i=t*30%360,s=(t*30+120)%360,n=(t*30+240)%360;e.addColorStop(0,`hsla(${i}, 70%, 50%, 0.1)`),e.addColorStop(.5,`hsla(${s}, 70%, 50%, 0.05)`),e.addColorStop(1,`hsla(${n}, 70%, 50%, 0.1)`),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}renderAcidEffects(t,e){const i=Date.now()*.001,s=S(t,e);this.ctx.save();for(let r=0;r<3;r++){const a=i+r*.5;this.ctx.translate(s.x,s.y),this.ctx.rotate(a*.3+r*Math.PI/3);for(let c=0;c<8;c++){this.ctx.save(),this.ctx.rotate(c/8*Math.PI*2);const h=(a*100+c*45)%360;this.ctx.fillStyle=`hsla(${h}, 100%, 60%, 0.1)`,this.ctx.strokeStyle=`hsla(${h+60}, 100%, 70%, 0.2)`,this.ctx.lineWidth=2;const l=Math.floor(a+c)%3,d=50+Math.sin(a*2+c)*30;this.ctx.beginPath(),l===0?(this.ctx.moveTo(0,-d),this.ctx.lineTo(-d*.866,d*.5),this.ctx.lineTo(d*.866,d*.5),this.ctx.closePath()):l===1?this.ctx.rect(-d/2,-d/2,d,d):this.ctx.arc(0,0,d/2,0,Math.PI*2),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}this.ctx.setTransform(1,0,0,1,0,0)}const n=.1+Math.sin(i*3)*.05;this.ctx.fillStyle=`hsla(${i*50%360}, 100%, 50%, ${n})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}renderWhipitsBalloons(t,e){const i=S(t,e),s=Date.now()*.001;for(let n=0;n<6;n++){const r=n/6*Math.PI*2+s*.3,a=40+Math.sin(s*2+n)*15,c=i.x+Math.cos(r)*a,h=i.y+Math.sin(r)*a-Math.sin(s*3+n)*10,l="🎈";this.ctx.font="24px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l,c,h),this.ctx.strokeStyle="#8b4513",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(c,h+12),this.ctx.lineTo(i.x,i.y+20),this.ctx.stroke()}}renderWhipitsVignetting(t){const e=this.canvas.width,i=this.canvas.height,s=e/2,n=i/2,r=Math.max(e,i)*.8,a=this.ctx.createRadialGradient(s,n,0,s,n,r);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(.6,"rgba(0, 0, 0, 0.3)"),a.addColorStop(.8,"rgba(20, 0, 0, 0.6)"),a.addColorStop(1,"rgba(40, 0, 0, 0.8)"),this.ctx.fillStyle=a,this.ctx.fillRect(0,0,e,i)}renderLSDEffects(t,e){const i=Date.now()*.001,s=S(t,e),n=this.canvas.width,r=this.canvas.height;for(let h=0;h<8;h++){const l=(i*2+h*Math.PI/4)%(Math.PI*2),d=50+Math.sin(i*3+h)*30,u=s.x+Math.cos(l)*d,f=s.y+Math.sin(l)*d;this.ctx.save(),this.ctx.translate(u,f),this.ctx.rotate(i*2+h);const g=["#ff00ff","#00ffff","#ffff00","#ff0080","#8000ff","#00ff80"];this.ctx.fillStyle=g[h%g.length],this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.moveTo(0,-20),this.ctx.lineTo(-17,10),this.ctx.lineTo(17,10),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}const a=.3+Math.sin(i*4)*.2,c=this.ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,Math.max(n,r)*.5);c.addColorStop(0,`rgba(255, 0, 255, ${a*.3})`),c.addColorStop(.3,`rgba(0, 255, 255, ${a*.2})`),c.addColorStop(.6,`rgba(255, 255, 0, ${a*.2})`),c.addColorStop(1,`rgba(255, 0, 128, ${a*.1})`),this.ctx.fillStyle=c,this.ctx.fillRect(0,0,n,r)}renderDMTEffects(t,e){const i=Date.now()*.001,s=S(t,e),n=this.canvas.width,r=this.canvas.height;this.ctx.save();for(let d=0;d<3;d++){const u=1+d*.5,f=2+d*1.5;for(let g=0;g<12;g++){const p=g/12*Math.PI*2+i*f,m=80+d*40+Math.sin(i*4+g+d)*30,b=s.x+Math.cos(p)*m,k=s.y+Math.sin(p)*m;this.ctx.save(),this.ctx.translate(b,k),this.ctx.rotate(i*f+g),this.ctx.scale(u,u);const L=(i*100+g*30+d*60)%360;this.ctx.fillStyle=`hsla(${L}, 100%, 60%, 0.4)`,this.ctx.strokeStyle=`hsla(${L+60}, 100%, 80%, 0.6)`,this.ctx.lineWidth=2,this.ctx.beginPath();for(let P=0;P<6;P++){const K=P/6*Math.PI*2,G=15+Math.sin(i*3+P)*8,et=Math.cos(K)*G,it=Math.sin(K)*G;P===0?this.ctx.moveTo(et,it):this.ctx.lineTo(et,it)}this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}}for(let d=0;d<8;d++){const u=d/8*Math.PI*2+i*1.5,f=60+Math.sin(i*2+d)*40,g=s.x+Math.cos(u)*f,p=s.y+Math.sin(u)*f,m=20+Math.sin(i*5+d)*15,b=.3+Math.sin(i*6+d)*.2,k=this.ctx.createRadialGradient(g,p,0,g,p,m);k.addColorStop(0,`rgba(255, 255, 255, ${b})`),k.addColorStop(.5,`rgba(255, 0, 255, ${b*.7})`),k.addColorStop(1,"rgba(0, 255, 255, 0)"),this.ctx.fillStyle=k,this.ctx.beginPath(),this.ctx.arc(g,p,m,0,Math.PI*2),this.ctx.fill()}const a=.4+Math.sin(i*3)*.3,c=this.ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,Math.max(n,r)*.8);c.addColorStop(0,`rgba(255, 0, 255, ${a*.4})`),c.addColorStop(.2,`rgba(0, 255, 255, ${a*.3})`),c.addColorStop(.4,`rgba(255, 255, 0, ${a*.3})`),c.addColorStop(.6,`rgba(255, 0, 128, ${a*.2})`),c.addColorStop(.8,`rgba(128, 0, 255, ${a*.2})`),c.addColorStop(1,`rgba(0, 128, 255, ${a*.1})`),this.ctx.fillStyle=c,this.ctx.fillRect(0,0,n,r);const h=i*200%360,l=.1+Math.sin(i*8)*.05;this.ctx.fillStyle=`hsla(${h}, 100%, 50%, ${l})`,this.ctx.fillRect(0,0,n,r);for(let d=0;d<16;d++){const u=d/16*Math.PI*2+i*2,f=200+Math.sin(i*3+d)*100,g=s.x+Math.cos(u)*f,p=s.y+Math.sin(u)*f,m=this.ctx.createLinearGradient(s.x,s.y,g,p);m.addColorStop(0,"rgba(255, 255, 255, 0.8)"),m.addColorStop(.5,"rgba(255, 0, 255, 0.4)"),m.addColorStop(1,"rgba(0, 255, 255, 0)"),this.ctx.strokeStyle=m,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(g,p),this.ctx.stroke()}this.ctx.restore()}renderCannabisEffects(t,e){const i=Date.now()*.001,s=S(t,e);this.ctx.save();for(let n=0;n<12;n++){const r=n/12*Math.PI*2+i*.3,a=40+Math.sin(i*1.5+n*.5)*20,c=s.x+Math.cos(r)*a,h=s.y+Math.sin(r)*a,l=3+Math.sin(i*2+n)*2,d=.6+Math.sin(i*1.5+n*.3)*.3,u=120+Math.sin(i+n)*20;this.ctx.fillStyle=`hsla(${u}, 70%, 60%, ${d})`,this.ctx.beginPath(),this.ctx.arc(c,h,l,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor=`hsl(${u}, 70%, 60%)`,this.ctx.shadowBlur=8,this.ctx.beginPath(),this.ctx.arc(c,h,l*.5,0,Math.PI*2),this.ctx.fill()}for(let n=0;n<6;n++){const r=n/6*Math.PI*2+i*.2,a=60+Math.sin(i*.8+n)*30,c=s.x+Math.cos(r)*a,h=s.y+Math.sin(r)*a,l=4+Math.sin(i*1.2+n)*2,d=.4+Math.sin(i*.9+n*.4)*.2;this.ctx.fillStyle=`hsla(120, 60%, 50%, ${d})`,this.ctx.shadowColor="transparent",this.ctx.save(),this.ctx.translate(c,h),this.ctx.rotate(r+i*.1),this.ctx.scale(1,.6),this.ctx.beginPath(),this.ctx.arc(0,0,l,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}this.ctx.restore()}}class Ie{constructor(){y(this,"inputState");this.inputState={keys:new Set,keyPressed:new Set},this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",t=>{const e=t.key.toLowerCase();this.inputState.keys.has(e)||this.inputState.keyPressed.add(e),this.inputState.keys.add(e)}),document.addEventListener("keyup",t=>{const e=t.key.toLowerCase();this.inputState.keys.delete(e),this.inputState.keyPressed.delete(e)})}getMovementDirection(){const{keys:t}=this.inputState;return t.has("w")&&t.has("a")||t.has("w")&&t.has("d")?"up":t.has("s")&&t.has("a")||t.has("s")&&t.has("d")?"down":t.has("w")||t.has("arrowup")?"up":t.has("s")||t.has("arrowdown")?"down":t.has("a")||t.has("arrowleft")?"left":t.has("d")||t.has("arrowright")?"right":null}isKeyPressed(t){return this.inputState.keys.has(t.toLowerCase())}getPressedKeys(){return Array.from(this.inputState.keys)}isRestKeyPressed(){return this.inputState.keys.has("e")}isMuteKeyPressed(){return this.inputState.keyPressed.has("m")}isEscapeKeyPressed(){return this.inputState.keyPressed.has("escape")}isKeyJustPressed(t){return this.inputState.keyPressed.has(t.toLowerCase())}isAnyKeyPressed(){return this.inputState.keyPressed.size>0}clearKeyPressed(){this.inputState.keyPressed.clear()}}class De{constructor(t,e,i,s,n,r){y(this,"gameState");y(this,"spatialIndex");y(this,"camera");y(this,"renderer");y(this,"inputHandler");y(this,"clock");y(this,"rng");y(this,"audio");y(this,"worldManager");y(this,"config");y(this,"lastTime",0);y(this,"animationId",null);y(this,"lastPlayerPosition",null);y(this,"actionSystem");y(this,"isPaused",!1);y(this,"tick",()=>{const t=this.clock.now(),e=(t-this.lastTime)/1e3;this.lastTime=t,this.update(e),this.render(),this.animationId=this.clock.requestAnimationFrame(this.tick)});this.clock=e,this.rng=i,this.audio=s,this.worldManager=n,this.config=r,this.renderer=new We(t,{canvasWidth:r.canvasWidth,canvasHeight:r.canvasHeight,playerSize:r.playerSize}),this.inputHandler=new Ie,this.spatialIndex=N(r.canvasWidth*2,r.canvasHeight*2,100),this.camera=Be({viewportWidth:r.canvasWidth,viewportHeight:r.canvasHeight,zoom:1,followSpeed:250,worldBounds:{minX:0,minY:0,maxX:1600,maxY:1200}}),this.initializeGameState()}initializeGameState(){const t=this.worldManager.getCurrentWorld(),e=this.worldManager.getCurrentWorldDimensions(),i=(t==null?void 0:t.spawnPosition)||x(this.config.canvasWidth/2,this.config.canvasHeight/2);this.rng.setSeed(this.config.seed),this.gameState={player:{position:i,stats:{coins:0,energy:100,mood:100,thirst:100,hunger:100,karma:0,speed:100},drugs:{active:[],maxStack:5},inventory:(()=>{const s=Nt();return D(s,"Water",3),D(s,"Grilled Cheese",1),D(s,"Energy Bar",1),s})(),isResting:!1},seed:this.config.seed,time:jt(),coins:[],moop:[]},this.spatialIndex=N(e.width,e.height,100),this.loadCoinsForCurrentWorld(),this.lastPlayerPosition={...i},window.addEventListener("toggleMute",()=>this.handleMuteToggle()),window.addEventListener("useInventoryItem",s=>this.handleInventoryItemClick(s.detail.itemType)),window.addEventListener("togglePause",()=>this.handlePauseToggle()),window.addEventListener("openMenu",()=>{this.isPaused||this.handlePauseToggle()}),window.addEventListener("closeMenu",()=>{this.isPaused&&this.handlePauseToggle()}),window.addEventListener("playerAction",s=>this.handlePlayerAction(s.detail.action)),this.actionSystem=qt(),console.log("Action system initialized with",this.actionSystem.actions.length,"actions")}start(){this.lastTime=this.clock.now(),this.tick()}stop(){this.animationId!==null&&(this.clock.cancelAnimationFrame(this.animationId),this.animationId=null)}update(t){if(this.isPaused)return;const e=this.worldManager.getCurrentTimeScale(),i=st(this.gameState.player.drugs),s=e*i;if(this.gameState.player.drugs.active.length>0){console.log("Active drugs:",this.gameState.player.drugs.active.length),console.log("Drug time scale:",i),console.log("Effective time scale:",s);const a=this.gameState.player.drugs.active.find(c=>c.type==="whipits");a&&console.log("WHIP IT ACTIVE! Duration:",a.duration,"Time scale:",a.effects.timeScale)}this.gameState.time=_t(this.gameState.time,t,s);const n=this.inputHandler.getMovementDirection();if(n){const a={direction:n,deltaTime:t};if(!this.gameState.player.isResting){const c=this.calculateDrugSpeedMultiplier(),h=dt(this.gameState.player.stats.speed,this.gameState.player.stats),l=h*c;this.gameState.player.drugs.active.length>0&&(console.log("Base speed:",this.gameState.player.stats.speed),console.log("Base effective speed:",h),console.log("Drug speed multiplier:",c),console.log("Final effective speed:",l));const d=Ct(this.gameState.player.position,a,l),u=this.worldManager.checkWorldTransition(d,this.config.playerSize);if(u&&u.success)this.handleWorldTransition(u);else{const f=this.worldManager.getCurrentWorldDimensions();this.gameState.player.position=bt(d,f.width,f.height,this.config.playerSize)}Math.random()<.1&&this.audio.playSound("playerMove",.1)}}Te(this.camera,this.gameState.player.position,t,this.camera.followSpeed);const r=this.lastPlayerPosition?j(this.lastPlayerPosition,this.gameState.player.position):0;this.applyNaturalDecay(r,t),this.applyRestingEffects(t),this.lastPlayerPosition={...this.gameState.player.position},this.checkCoinPickups(),this.checkRestAction(),this.checkMuteToggle(),this.checkMenuToggle(),this.checkInventoryHotkeys(),this.checkActionHotkeys(),this.updateNotifications(t),this.inputHandler.clearKeyPressed()}checkCoinPickups(){const t=this.gameState.player.position,e=this.config.playerSize/2,i=12;ut(this.spatialIndex,t,e+i).entities.forEach(n=>{const r=this.gameState.coins.find(a=>a.id===n.id);if(r&&!r.collected&&Pt(t,e,r.position,i)){const a=Pe(r.value);{r.collected=!0,this.gameState.player.stats=W(this.gameState.player.stats,a.statDelta),he(this.spatialIndex,r.id),Ut(r.value,r.position);const c=this.worldManager.getCurrentWorldId();this.worldManager.getWorldStateManager().updateWorldItem(c,r.id,{collected:!0}),this.audio.playSound("coinPickup",.5)}}}),this.checkCollectibleCollection(t,e),this.checkMoopCollection(t,e)}checkMoopCollection(t,e){ve(t,e,this.gameState.moop).forEach(s=>{const n=Me(s,this.gameState.player.stats);if(n.success){this.gameState.player.stats=n.newStats;const r=this.gameState.moop.findIndex(h=>h.id===s.id);r!==-1&&(this.gameState.moop[r].collected=!0);const a=ge(s.type);C().addNotification(`+1 ${a} (+${n.karmaGained} karma)`,"item",n.karmaGained,s.position),this.audio.playSound("coinPickup",.3)}})}checkCollectibleCollection(t,e){const i=this.worldManager.getCurrentWorldId(),s=this.worldManager.getWorldStateManager(),n=s.getWorldState(i);((n==null?void 0:n.items)||[]).forEach(a=>{var c,h;if(!a.collected&&a.type!=="coin"&&Et(t,e,a.position,15)){switch(s.updateWorldItem(i,a.id,{collected:!0}),a.type){case"water":D(this.gameState.player.inventory,"Water",1),J("Water",a.position);break;case"food":const l=(c=a.data)==null?void 0:c.subtype;l&&R[l]&&(D(this.gameState.player.inventory,l,1),J(l,a.position));break;case"drug":const d=(h=a.data)==null?void 0:h.subtype;if(d){console.log("Adding drug effect:",d);const u=$t(d,1);console.log("Created drug effect:",u),this.gameState.player.drugs=Lt(this.gameState.player.drugs,u),console.log("Drugs after adding:",this.gameState.player.drugs.active.length,"active drugs"),J(d,a.position);const f=lt[d];if(f&&f.effects){console.log("Applying immediate drug stat effects:",f.effects);const g={energy:f.effects.energy,mood:f.effects.mood,thirst:f.effects.thirst,hunger:f.effects.hunger,karma:f.effects.karma};if(this.gameState.player.stats=W(this.gameState.player.stats,g),f.effects.mood&&f.effects.mood!==0&&w("mood",f.effects.mood,a.position),f.effects.energy&&f.effects.energy!==0&&w("energy",f.effects.energy,a.position),f.effects.thirst&&f.effects.thirst!==0&&w("thirst",f.effects.thirst,a.position),f.effects.hunger&&f.effects.hunger!==0&&w("hunger",f.effects.hunger,a.position),f.effects.karma&&f.effects.karma!==0&&w("karma",f.effects.karma,a.position),f.effects.speed&&f.effects.speed!==0&&w("speed",f.effects.speed,a.position),f.effects.timeScale&&f.effects.timeScale!==1){const p=((f.effects.timeScale-1)*100).toFixed(0);C().addNotification(`Time: ${parseFloat(p)>0?"+":""}${p}%`,"item",1,a.position)}}}break}this.audio.playSound("coinPickup",.3)}})}applyRestingEffects(t){if(this.gameState.player.isResting){const e=12*t,i=Math.min(100,this.gameState.player.stats.energy+e);if(i!==this.gameState.player.stats.energy){const s=Math.floor(this.gameState.player.stats.energy);this.gameState.player.stats.energy=i;const n=Math.floor(i);if(n>s){const r=n-s;C().addNotification(`+${r} Energy`,"energy",r,this.gameState.player.position)}}this.gameState.player.stats.energy>=100&&(this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3))}}applyNaturalDecay(t,e){const i=this.worldManager.getCurrentTimeScale(),s=e;this.gameState.player.drugs.active.length>0&&(console.log("Before update - active drugs:",this.gameState.player.drugs.active.map(r=>`${r.type}: ${r.duration.toFixed(1)}s`)),console.log("Time scales - world:",i,"gameTimeDelta:",s)),this.gameState.player.drugs=Ft(this.gameState.player.drugs,s),this.gameState.player.drugs.active.length>0&&console.log("After update - active drugs:",this.gameState.player.drugs.active.map(r=>`${r.type}: ${r.duration.toFixed(1)}s`));const n=At(t,e,this.gameState.player.stats);this.gameState.player.stats=W(this.gameState.player.stats,n)}checkRestAction(){if(this.inputHandler.isRestKeyPressed()){const t=Ee(20,10);this.gameState.player.stats=W(this.gameState.player.stats,t.statDelta),this.audio.playSound("playerRest",.3)}}checkMuteToggle(){if(this.inputHandler.isMuteKeyPressed()){const t=this.audio.isMuted();this.audio.setMuted(!t),this.audio.playSound("buttonClick",.2)}}checkMenuToggle(){this.inputHandler.isEscapeKeyPressed()&&(window.dispatchEvent(new CustomEvent("toggleMenu")),this.audio.playSound("buttonClick",.2))}handleMuteToggle(){const t=this.audio.isMuted();this.audio.setMuted(!t),this.audio.playSound("buttonClick",.2)}checkInventoryHotkeys(){Object.values(R).forEach(t=>{if(t.hotkey&&this.inputHandler.isKeyJustPressed(t.hotkey)){const e=nt(this.gameState.player.inventory,t.type,this.gameState.player.stats);e.success&&(this.gameState.player.stats=e.newStats,this.audio.playSound("buttonClick",.3),this.showItemUsageNotifications(t.type))}})}checkActionHotkeys(){if(this.gameState.player.isResting&&this.inputHandler.isAnyKeyPressed()){this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3);return}this.inputHandler.isKeyJustPressed("r")&&this.handleRestAction()}handleRestAction(){this.gameState.player.isResting?(this.gameState.player.isResting=!1,this.audio.playSound("buttonClick",.3)):(this.gameState.player.isResting=!0,this.audio.playSound("playerRest",.5))}handleInventoryItemClick(t){this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to use item:",t));const e=nt(this.gameState.player.inventory,t,this.gameState.player.stats);e.success&&(this.gameState.player.stats=e.newStats,this.audio.playSound("buttonClick",.3),this.showItemUsageNotifications(t))}handlePauseToggle(){this.isPaused=!this.isPaused,this.audio.playSound("buttonClick",.2),console.log("Game paused:",this.isPaused),window.dispatchEvent(new CustomEvent("pauseStateUpdate",{detail:{isPaused:this.isPaused}}))}handlePlayerAction(t){switch(console.log("Player action:",t),t){case"rest":this.handleRestAction();break;case"explore":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to explore"));break;case"gift":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to give gift"));break;case"help":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to help stranger"));break;case"battle":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest for silly battle"));break;case"meditate":this.gameState.player.isResting&&(this.gameState.player.isResting=!1,console.log("Woke up from rest to meditate"));break;default:console.log("Unknown action:",t)}this.audio.playSound("buttonClick",.2)}updateNotifications(t){C().updateNotifications(t)}calculateDrugSpeedMultiplier(){let t=1;for(const e of this.gameState.player.drugs.active)e.effects.speed&&(t+=e.effects.speed*e.intensity/100);return Math.max(.1,t)}showItemUsageNotifications(t){const e=R[t];if(!e)return;const i=this.gameState.player.position;e.effects.thirst&&w("thirst",e.effects.thirst,i),e.effects.hunger&&w("hunger",e.effects.hunger,i),e.effects.energy&&w("energy",e.effects.energy,i),e.effects.mood&&w("mood",e.effects.mood,i),e.effects.karma&&w("karma",e.effects.karma,i),e.effects.speed&&w("speed",e.effects.speed,i)}handleWorldTransition(t){this.gameState.player.position=t.newPosition;const e=this.worldManager.getCurrentWorldDimensions();this.camera.worldBounds={minX:0,minY:0,maxX:e.width,maxY:e.height},V(this.camera,t.newPosition),this.spatialIndex=N(e.width,e.height,100),this.loadCoinsForCurrentWorld(),this.audio.playSound("gameStart",.3),t.message&&console.log(t.message)}loadCoinsForCurrentWorld(){const t=this.worldManager.getCurrentWorldId(),s=this.worldManager.getWorldStateManager().getWorldState(t).items.filter(n=>n.type==="coin");s.length>0?(this.gameState.coins=s.map(n=>{var r;return{id:n.id,position:n.position,value:((r=n.data)==null?void 0:r.value)||1,collected:n.collected}}),this.gameState.coins.forEach(n=>{n.collected||I(this.spatialIndex,{id:n.id,position:n.position,radius:8})})):this.spawnCoinsForCurrentWorld()}spawnCoinsForCurrentWorld(){const t=this.worldManager.getCurrentWorldId(),e=this.worldManager.getCurrentWorldDimensions(),i=this.gameState.player.position,s=this.worldManager.getWorldStateManager();this.rng.setSeed(this.config.seed+t.length);const n=ne(this.gameState.time.day),r=ue(this.rng,e.width,e.height,i,this.spatialIndex,Math.floor(this.config.coinCount*n),Math.floor(8*n),Math.floor(10*n),Math.floor(5*n)),a={count:Math.floor(6*n),minDistanceFromPlayer:100,minDistanceFromOtherMoop:30,worldBounds:{minX:0,maxX:e.width,minY:0,maxY:e.height}},c=Se(a,i,[],this.rng);this.gameState.moop=c,this.gameState.coins=r.filter(h=>h.type==="coin").map(h=>({id:h.id,position:h.position,value:h.value,collected:h.collected})),r.forEach(h=>{s.addWorldItem(t,{id:h.id,type:h.type,position:h.position,collected:h.collected,data:{value:h.value,subtype:h.subtype}})})}render(){const t=this.worldManager.getCurrentWorldBackgroundColor(),e=Qt(this.gameState.time,t),i=se(this.worldManager.getCurrentWorldId(),this.gameState.time),s=this.audio.isMuted(),n=this.worldManager.getCurrentTimeScale(),r=st(this.gameState.player.drugs),a=n*r,c=this.gameState.player.drugs.active,h=this.worldManager.getCurrentWorldId(),d=this.worldManager.getWorldStateManager().getWorldState(h),u=(d==null?void 0:d.items)||[];this.renderer.render(this.gameState,this.camera,this.spatialIndex,e,i,s,a,c,this.worldManager.getCurrentWorldId(),u,this.gameState.moop),window.dispatchEvent(new CustomEvent("gameStateUpdate",{detail:this.gameState}))}getGameState(){return{...this.gameState}}reset(){this.initializeGameState()}loadGameState(t){this.gameState={...t},this.lastPlayerPosition={...t.player.position},this.spatialIndex=N(this.config.canvasWidth*2,this.config.canvasHeight*2,100),t.coins.forEach(e=>{e.collected||I(this.spatialIndex,{id:e.id,position:e.position,radius:8})}),V(this.camera,t.player.position)}}class Re{now(){return performance.now()}requestAnimationFrame(t){return requestAnimationFrame(t)}cancelAnimationFrame(t){cancelAnimationFrame(t)}}class Ae{constructor(t=Date.now()){y(this,"seed");y(this,"current");this.seed=t,this.current=t}random(){return this.current=(this.current*1664525+1013904223)%4294967296,this.current/4294967296}randomInt(t,e){return Math.floor(this.randomRange(t,e))}randomRange(t,e){return t+this.random()*(e-t)}setSeed(t){this.seed=t,this.current=t}getSeed(){return this.seed}}class $e{constructor(t="wombat-quest-"){y(this,"prefix");this.prefix=t}getKey(t){return this.prefix+t}async save(t,e){try{const i=JSON.stringify(e);localStorage.setItem(this.getKey(t),i)}catch(i){throw new Error(`Failed to save data for key "${t}": ${i}`)}}async load(t){try{const e=localStorage.getItem(this.getKey(t));return e===null?null:JSON.parse(e)}catch(e){throw new Error(`Failed to load data for key "${t}": ${e}`)}}async remove(t){try{localStorage.removeItem(this.getKey(t))}catch(e){throw new Error(`Failed to remove data for key "${t}": ${e}`)}}async exists(t){try{return localStorage.getItem(this.getKey(t))!==null}catch(e){throw new Error(`Failed to check existence for key "${t}": ${e}`)}}async keys(){try{const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);i&&i.startsWith(this.prefix)&&t.push(i.substring(this.prefix.length))}return t}catch(t){throw new Error(`Failed to get keys: ${t}`)}}}class Fe{constructor(){y(this,"audioContext");y(this,"sounds",new Map);y(this,"masterVolume",.7);y(this,"muted",!0);y(this,"masterGainNode");this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGainNode=this.audioContext.createGain(),this.masterGainNode.connect(this.audioContext.destination),this.masterGainNode.gain.value=this.masterVolume;const t=()=>{this.audioContext.state==="suspended"&&this.audioContext.resume(),document.removeEventListener("click",t),document.removeEventListener("keydown",t)};document.addEventListener("click",t),document.addEventListener("keydown",t)}async loadSound(t,e){try{const s=await(await fetch(e)).arrayBuffer(),n=await this.audioContext.decodeAudioData(s);this.sounds.set(t,{buffer:n})}catch(i){console.warn(`Failed to load sound ${t}:`,i);const s=this.audioContext.createBuffer(1,1,22050);this.sounds.set(t,{buffer:s})}}playSound(t,e=1){if(this.muted)return;this.audioContext.state==="suspended"&&this.audioContext.resume();const i=this.sounds.get(t);if(!i){console.warn(`Sound ${t} not found`);return}try{const s=this.audioContext.createBufferSource();s.buffer=i.buffer;const n=this.audioContext.createGain();n.gain.value=e*this.masterVolume,s.connect(n),n.connect(this.masterGainNode),s.start(0)}catch(s){console.warn(`Failed to play sound ${t}:`,s)}}stopSound(t){const e=this.sounds.get(t);if(e&&e.source)try{e.source.stop(),e.source.disconnect(),e.source=void 0}catch{}}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.masterGainNode.gain.value=this.muted?0:this.masterVolume}getMasterVolume(){return this.masterVolume}setMuted(t){this.muted=t,this.masterGainNode.gain.value=t?0:this.masterVolume}isMuted(){return this.muted}async preloadGameSounds(){const t={coinPickup:this.generateCoinPickupSound(),playerMove:this.generatePlayerMoveSound(),playerRest:this.generatePlayerRestSound(),buttonClick:this.generateButtonClickSound(),gameStart:this.generateGameStartSound(),gameOver:this.generateGameOverSound()},e=Object.entries(t).map(([i,s])=>this.loadSound(i,s));await Promise.all(e)}generateCoinPickupSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.2*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*8),c=800+400*Math.sin(r*20);s[n]=a*.3*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}generatePlayerMoveSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.1*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*15),c=200+100*Math.random();s[n]=a*.1*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}generatePlayerRestSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.5*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*2),c=150-50*r;s[n]=a*.2*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}generateButtonClickSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.05*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*30),c=1e3;s[n]=a*.2*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}generateGameStartSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,.8*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*1.5),c=400+200*r;s[n]=a*.3*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}generateGameOverSound(){const e=this.audioContext.sampleRate,i=this.audioContext.createBuffer(1,1*e,e),s=i.getChannelData(0);for(let n=0;n<s.length;n++){const r=n/e,a=Math.exp(-r*1),c=600-400*r;s[n]=a*.25*Math.sin(2*Math.PI*c*r)}return this.bufferToDataUrl(i)}bufferToDataUrl(t){const e=t.length,i=t.sampleRate,s=new ArrayBuffer(44+e*2),n=new DataView(s),r=(l,d)=>{for(let u=0;u<d.length;u++)n.setUint8(l+u,d.charCodeAt(u))};r(0,"RIFF"),n.setUint32(4,36+e*2,!0),r(8,"WAVE"),r(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,i,!0),n.setUint32(28,i*2,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),r(36,"data"),n.setUint32(40,e*2,!0);const a=t.getChannelData(0);let c=44;for(let l=0;l<e;l++){const d=Math.max(-1,Math.min(1,a[l]));n.setInt16(c,d*32767,!0),c+=2}const h=new Blob([s],{type:"audio/wav"});return URL.createObjectURL(h)}}class Le{constructor(t={}){y(this,"gameLoop",null);y(this,"clock");y(this,"rng");y(this,"storage");y(this,"audio");y(this,"worldManager");this.clock=new Re,this.rng=new Ae(t.seed),this.storage=new $e,this.audio=new Fe;const e=new ee(this.storage);this.worldManager=new ie("camp",e);const i={canvasWidth:t.canvasWidth??800,canvasHeight:t.canvasHeight??600,playerSize:t.playerSize??32,seed:this.rng.getSeed(),coinCount:t.coinCount??10};this.initializeGame(i)}initializeGame(t){const e=document.getElementById("gameCanvas");if(!e)throw new Error('Canvas element with id "gameCanvas" not found');this.gameLoop=new De(e,this.clock,this.rng,this.audio,this.worldManager,t)}async start(){if(!this.gameLoop)throw new Error("Game loop not initialized");try{await this.audio.preloadGameSounds(),console.log("Audio system initialized successfully")}catch(t){console.warn("Audio initialization failed, continuing without audio:",t)}this.gameLoop.start()}stop(){this.gameLoop&&this.gameLoop.stop()}reset(){this.gameLoop&&this.gameLoop.reset()}getRng(){return this.rng}getClock(){return this.clock}getAudio(){return this.audio}getWorldManager(){return this.worldManager}async saveGame(t="autosave"){if(!this.gameLoop)throw new Error("Game loop not initialized");const i={gameState:this.gameLoop.getGameState(),timestamp:Date.now(),version:"1.0.0"};await this.storage.save(t,i)}async loadGame(t="autosave"){if(!this.gameLoop)throw new Error("Game loop not initialized");try{const e=await this.storage.load(t);return e?(this.gameLoop.loadGameState(e.gameState),!0):!1}catch(e){return console.error("Failed to load game:",e),!1}}async hasSave(t="autosave"){return await this.storage.exists(t)}getStorage(){return this.storage}}const T=new Le({canvasWidth:window.innerWidth,canvasHeight:window.innerHeight,playerSize:32,seed:Math.floor(Math.random()*1e6),coinCount:30}),B=document.getElementById("menuOverlay"),Ge=document.getElementById("closeMenu"),A=document.getElementById("volumeSlider"),gt=document.getElementById("volumeDisplay"),yt=T.getAudio();yt.setMasterVolume(A.value/100);gt.textContent=A.value+"%";A.addEventListener("input",()=>{const o=A.value/100;yt.setMasterVolume(o),gt.textContent=A.value+"%"});function pt(){!B.classList.contains("show")?(B.classList.add("show"),window.dispatchEvent(new CustomEvent("openMenu"))):(B.classList.remove("show"),window.dispatchEvent(new CustomEvent("closeMenu")))}function _(){B.classList.contains("show")&&(B.classList.remove("show"),window.dispatchEvent(new CustomEvent("closeMenu")))}Ge.addEventListener("click",_);B.addEventListener("click",o=>{o.target===B&&_()});window.addEventListener("toggleMenu",pt);const Ne=document.getElementById("seedDisplay"),He=document.getElementById("resetSeedDisplay"),ze=T.getRng(),xt=ze.getSeed();Ne.textContent=xt.toString();He.textContent=xt.toString();const Ye=document.getElementById("resetSeed");Ye.addEventListener("click",()=>{T.reset(),_()});const Xe=document.getElementById("resumeGame");Xe.addEventListener("click",()=>{_()});const Ue=document.getElementById("saveGame"),Oe=document.getElementById("loadGame"),U=document.getElementById("statusMessage");function $(o,t=!0){U.textContent=o,U.className=`status-message ${t?"status-success":"status-error"}`,U.style.display="block",setTimeout(()=>{U.style.display="none"},3e3)}Ue.addEventListener("click",async()=>{try{await T.saveGame(),$("Game saved successfully!",!0)}catch(o){$("Failed to save game",!1),console.error("Save error:",o)}});Oe.addEventListener("click",async()=>{try{await T.loadGame()?$("Game loaded successfully!",!0):$("No save data found",!1)}catch(o){$("Failed to load game",!1),console.error("Load error:",o)}});window.addEventListener("resize",()=>{const o=document.getElementById("gameCanvas");o.width=window.innerWidth,o.height=window.innerHeight});function qe(o){const t=o.player.stats;document.getElementById("thirst-bar").style.width=`${Math.max(0,Math.min(100,t.thirst))}%`,document.getElementById("hunger-bar").style.width=`${Math.max(0,Math.min(100,t.hunger))}%`,document.getElementById("energy-bar").style.width=`${Math.max(0,Math.min(100,t.energy))}%`,document.getElementById("mood-bar").style.width=`${Math.max(0,Math.min(100,t.mood))}%`,document.getElementById("thirst-value").textContent=Math.round(t.thirst),document.getElementById("hunger-value").textContent=Math.round(t.hunger),document.getElementById("energy-value").textContent=Math.round(t.energy),document.getElementById("mood-value").textContent=Math.round(t.mood),document.getElementById("coin-amount").textContent=t.coins,document.getElementById("karma-amount").textContent=Math.round(t.karma)}function Ve(o){return{Water:"W","Grilled Cheese":"J","Energy Bar":"E",Trinket:"T",Clothing:"C","Veggie Burger":"V","Fruit Salad":"F","Pizza Slice":"P",Smoothie:"S",Popsicle:"O",Burrito:"B",Taco:"A","Ice Cream":"I","Corn Dog":"D","Funnel Cake":"U",Nachos:"N","Cotton Candy":"Y","Gas Can":"G"}[o]||null}const O=new Map;function je(o){const t=document.getElementById("inventory-list"),e=o.player.inventory;if(!e||!e.items)return;const i={Water:"💧","Grilled Cheese":"🧀","Energy Bar":"⚡",Trinket:"✨",Clothing:"👕","Veggie Burger":"🍔","Fruit Salad":"🥗","Pizza Slice":"🍕",Smoothie:"🥤",Popsicle:"🍭",Burrito:"🌯",Taco:"🌮","Ice Cream":"🍦","Corn Dog":"🌭","Funnel Cake":"🧁",Nachos:"🌽","Cotton Candy":"🍬","Gas Can":"⛽"},s=new Set;e.items.forEach((n,r)=>{if(s.add(r),n>0){let a=O.get(r);if(a){const c=a.querySelector(".quantity");c&&(c.textContent=n)}else{a=document.createElement("div"),a.className="inventory-item",a.style.cursor="pointer";const c=i[r]||"📦",h=Ve(r),l=h?` [${h}]`:"";a.innerHTML=`
                            <span>${c} ${r}${l}</span>
                            <span class="quantity">${n}</span>
                        `,a.addEventListener("click",()=>{console.log("Inventory item clicked:",r),window.dispatchEvent(new CustomEvent("useInventoryItem",{detail:{itemType:r}}))}),O.set(r,a),t.appendChild(a)}}});for(const[n,r]of O)s.has(n)||(r.remove(),O.delete(n))}function _e(o){const t=document.getElementById("time-display"),e=o.time,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(e.day+5)%7],s=`${e.hour.toString().padStart(2,"0")}:${e.minute.toString().padStart(2,"0")}`;t.textContent=`Day ${e.day} (${i}) • ${s}`}function Ke(o){const t=document.getElementById("drug-effects-panel"),e=document.getElementById("drug-effects-list"),i=o.player.drugs;if(!i||!i.active||i.active.length===0){t.style.display="none";return}t.style.display="block",e.innerHTML="",i.active.forEach(s=>{const n=document.createElement("div");n.className="drug-effect-item",n.innerHTML=`
                    <span class="drug-effect-icon">💊</span>
                    <span class="drug-effect-text">${s.type}</span>
                    <span class="drug-effect-duration">${Math.round(s.duration)}s</span>
                `,e.appendChild(n)})}function Je(o){const t=document.getElementById("speed-display"),e=document.getElementById("time-perception-display");if(!o||!o.player)return;const i=o.player.stats;i.speed;let s=1;i.energy<30&&(s*=.7),i.thirst<30&&(s*=.8),i.hunger<30&&(s*=.8),i.mood<30&&(s*=.9),o.player.drugs&&o.player.drugs.active&&o.player.drugs.active.forEach(a=>{a.effects&&a.effects.speed&&(s+=a.effects.speed*a.intensity/100)});const n=Math.max(.1,s);let r=1;o.player.drugs&&o.player.drugs.active&&o.player.drugs.active.forEach(a=>{a.effects&&a.effects.timeScale&&(r*=a.effects.timeScale)}),t.textContent=`${n.toFixed(1)}x`,e.textContent=`${r.toFixed(1)}x`}function Qe(o){const t=document.getElementById("pause-btn");t&&(o?t.classList.add("paused"):t.classList.remove("paused"))}function Ze(o){qe(o),je(o),_e(o),Ke(o),Je(o)}window.addEventListener("gameStateUpdate",o=>{Ze(o.detail)});window.addEventListener("pauseStateUpdate",o=>{Qe(o.detail.isPaused)});const rt=document.getElementById("pause-btn");rt&&rt.addEventListener("click",()=>{pt()});document.querySelectorAll(".action-btn").forEach(o=>{o.addEventListener("click",()=>{const t=o.getAttribute("data-action");t&&window.dispatchEvent(new CustomEvent("playerAction",{detail:{action:t}}))})});T.start().catch(o=>{console.error("Failed to start game:",o),document.getElementById("seedDisplay").textContent="Error loading game"});window.addEventListener("beforeunload",()=>{T.stop()});
